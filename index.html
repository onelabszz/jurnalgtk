
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Jurnal Guru Mobile</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
  </script>

  <style>
    /* UTILITIES */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    input, textarea { font-size: 16px !important; }
    
    /* ANIMATIONS */
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    .voice-wave { animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
    @keyframes pulse-ring { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .toast-anim { animation: slideDown 0.3s ease-out forwards; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* PRINT STYLES - ADVANCED */
    @media print {
      @page { size: landscape; margin: 10mm; }
      body { background-color: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; font-family: sans-serif; }
      .no-print { display: none !important; }
      .print-only { display: block !important; width: 100%; }
      
      thead { display: table-header-group; }
      tfoot { display: table-footer-group; }
      tr { page-break-inside: avoid; page-break-after: auto; }
      td, th { border: 1px solid black !important; padding: 4px; }
      .signature-block { page-break-inside: avoid; margin-top: 20px; }
      
      #root > div { max-width: none !important; box-shadow: none !important; margin: 0 !important; padding: 0 !important; }
      .print-container { width: 100%; }
    }
    .print-only { display: none; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased selection:bg-blue-100 selection:text-blue-900">
  
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { 
      BookOpen, Calendar, Camera, ChevronDown, ChevronUp, ChevronRight, ChevronLeft,
      Clock, LogOut, Plus, Save, User, CheckCircle2, 
      Home, BarChart2, Settings, FileText, Bell, Loader2, Link, Printer, Database,
      Mic, Pencil, Trash2, X, FileSpreadsheet, LayoutGrid, List, Image, Users, KeyRound, School,
      TrendingUp, ListChecks, AlertCircle, CheckCircle, ShieldCheck, ArrowLeft, ExternalLink, Eye, Download
    } from 'lucide-react';

    // ==========================================
    // 1. KONFIGURASI & HELPER
    // ==========================================
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxZdbql7FcEdv8808ikm9fpaYRylggG1alsCRZ18uFdJk2iYjCPqbGfuClhBCW7t0RclA/exec"; 

    const compressImage = (file) => {
      return new Promise((resolve, reject) => {
        const MAX_WIDTH = 1024; const QUALITY = 0.7;    
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
          const img = new Image();
          img.src = event.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width; let height = img.height;
            if (width > MAX_WIDTH) { height = Math.round((height * MAX_WIDTH) / width); width = MAX_WIDTH; }
            canvas.width = width; canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/jpeg', QUALITY));
          };
          img.onerror = (err) => reject(err);
        };
        reader.onerror = (err) => reject(err);
      });
    };

    const formatDateIndo = (dateStr) => {
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      return new Date(dateStr).toLocaleDateString('id-ID', options);
    };

    const DEFAULT_KEGIATAN = ["Melaksanakan KBM", "Membuat perangkat ajar", "Evaluasi Siswa"];
    const DEFAULT_HASIL = ["KBM berjalan lancar", "Dokumen tersimpan", "Nilai terekap"];

    // ==========================================
    // 2. KOMPONEN UI DASAR
    // ==========================================

    function Toast({ message, type, onClose }) {
      useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, [onClose]);
      const bgClass = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-gray-800';
      const icon = type === 'success' ? <CheckCircle size={20} /> : type === 'error' ? <AlertCircle size={20} /> : <Bell size={20} />;
      return (
        <div className={`fixed top-4 left-4 right-4 z-[100] md:left-1/2 md:-translate-x-1/2 md:w-auto md:min-w-[300px] flex items-center gap-3 px-4 py-3 rounded-xl shadow-2xl text-white ${bgClass} toast-anim`}>
           <div>{icon}</div><p className="text-sm font-bold flex-1">{message}</p><button onClick={onClose}><X size={16} className="opacity-70 hover:opacity-100" /></button>
        </div>
      );
    }

    function NavButton({ icon, label, active, onClick }) {
      return (
        <button onClick={onClick} className={`flex flex-col items-center justify-center w-full py-1 transition-all duration-300 ${active ? 'text-blue-600' : 'text-gray-400 hover:text-gray-600'}`}>
          <div className={`transition-transform duration-300 ${active ? '-translate-y-1' : ''}`}>{icon}</div>
          <span className={`text-[10px] font-medium mt-1 ${active ? 'opacity-100' : 'opacity-0 h-0 overflow-hidden'}`}>{label}</span>
        </button>
      );
    }

    function VoiceInputButton({ onResult }) {
      const [isListening, setIsListening] = useState(false);
      const recognitionRef = useRef(null);
      const startListening = () => {
        if (!window.webkitSpeechRecognition) { alert("Fitur suara butuh browser Chrome/Edge."); return; }
        try {
            const recognition = new window.webkitSpeechRecognition();
            recognition.lang = 'id-ID'; recognition.continuous = false; recognition.interimResults = false;
            recognition.onstart = () => setIsListening(true);
            recognition.onend = () => setIsListening(false);
            recognition.onerror = (e) => { console.error(e); setIsListening(false); };
            recognition.onresult = (e) => { const t = e.results[0][0].transcript; onResult(t.charAt(0).toUpperCase() + t.slice(1)); };
            recognitionRef.current = recognition; recognition.start();
        } catch(e) { setIsListening(false); }
      };
      return (
        <button type="button" onClick={isListening ? () => recognitionRef.current?.stop() : startListening} className={`p-2 rounded-full transition-all ${isListening ? 'bg-red-500 text-white voice-wave' : 'bg-gray-100 text-gray-500 hover:bg-blue-100 hover:text-blue-600'}`}>
          {isListening ? <X size={16} /> : <Mic size={16} />}
        </button>
      );
    }

    function CalendarView({ entries = [], onSelectDate, selectedDate }) {
      const [currentMonth, setCurrentMonth] = useState(new Date());
      const getDaysInMonth = (date) => { const year = date.getFullYear(); const month = date.getMonth(); return { days: new Date(year, month + 1, 0).getDate(), firstDay: new Date(year, month, 1).getDay() }; };
      const { days, firstDay } = getDaysInMonth(currentMonth);
      const daysArray = [...Array(days).keys()].map(i => i + 1);
      const emptyDays = Array(firstDay).fill(null);
      
      const hasEntry = (day) => { const d = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day); return entries.some(e => new Date(parseInt(e.id)).toDateString() === d.toDateString()); };
      const isSelected = (day) => { if (!selectedDate) return false; return selectedDate.toDateString() === new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day).toDateString(); };
      
      return (
        <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-4">
          <div className="flex justify-between items-center mb-4">
             <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1))} className="p-1 hover:bg-gray-100 rounded-full"><ChevronLeft size={20}/></button>
             <h3 className="font-bold text-gray-800">{currentMonth.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })}</h3>
             <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1))} className="p-1 hover:bg-gray-100 rounded-full"><ChevronRight size={20}/></button>
          </div>
          <div className="grid grid-cols-7 gap-1 text-center mb-2">
            {['M', 'S', 'S', 'R', 'K', 'J', 'S'].map((d, i) => <div key={i} className="text-xs font-bold text-gray-400">{d}</div>)}
          </div>
          <div className="grid grid-cols-7 gap-1">
            {emptyDays.map((_, i) => <div key={`empty-${i}`}></div>)}
            {daysArray.map(day => (
              <button key={day} onClick={() => onSelectDate(new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day))}
                className={`h-9 w-9 rounded-full flex flex-col items-center justify-center text-sm relative transition-all ${isSelected(day) ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-gray-100 text-gray-700'}`}>
                <span>{day}</span>
                {hasEntry(day) && (<span className={`w-1.5 h-1.5 rounded-full absolute bottom-1 transition-colors ${isSelected(day) ? 'bg-white' : 'bg-green-500'}`}></span>)}
              </button>
            ))}
          </div>
        </div>
      );
    }

    // ==========================================
    // 3. KOMPONEN CETAK LAPORAN (ADVANCED)
    // ==========================================

    function PrintableReport({ user, entries = [], principalInfo, kota }) {
      const bulanIni = new Date().toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
      return (
        <div className="print-only print-container text-black text-xs">
          <div className="text-center mb-6">
            <h1 className="text-xl font-bold uppercase border-b-2 border-black pb-1 inline-block px-10">Laporan Kinerja Harian Guru</h1>
            <h2 className="text-sm mt-1">Periode: {bulanIni}</h2>
          </div>
          <div className="flex justify-between mb-4">
             <table className="w-1/2"><tbody><tr><td className="w-24 font-bold">Nama</td><td>: {user.nama}</td></tr><tr><td className="font-bold">NIP</td><td>: {user.nip}</td></tr></tbody></table>
             <table className="w-1/2 text-right"><tbody><tr><td className="w-24 font-bold">Unit Kerja</td><td>: {user.sekolah}</td></tr><tr><td className="font-bold">Jabatan</td><td>: {user.role}</td></tr></tbody></table>
          </div>
          <table className="w-full border-collapse border border-black text-xs mb-8">
            <thead>
              <tr className="bg-gray-200 text-center font-bold">
                <th className="p-2 w-10">No</th>
                <th className="p-2 w-32">Hari/Tanggal</th>
                <th className="p-2 w-24">Waktu</th>
                <th className="p-2">Uraian Kegiatan</th>
                <th className="p-2 w-1/4">Hasil / Output</th>
                <th className="p-2 w-24">Ket</th>
              </tr>
            </thead>
            <tbody>
              {entries.length === 0 ? (<tr><td colSpan="6" className="p-4 text-center italic">Tidak ada data.</td></tr>) : (
                entries.map((e, idx) => (
                  <tr key={idx}>
                    <td className="p-2 text-center align-top">{idx + 1}</td>
                    <td className="p-2 align-top text-center">{formatDateIndo(parseInt(e.id))}</td>
                    <td className="p-2 text-center align-top whitespace-nowrap">{e.jamMulai} - {e.jamSelesai}</td>
                    <td className="p-2 align-top text-justify">{e.kegiatan}</td>
                    <td className="p-2 align-top text-justify">{e.hasil}</td>
                    <td className="p-2 align-top text-center">{e.foto ? "Ada Foto" : "-"}</td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
          <div className="flex justify-between mt-10 px-10 signature-block">
             <div className="text-center w-64"><p>Mengetahui,</p><p className="font-bold mb-20">Kepala Sekolah</p><p className="font-bold border-b border-black inline-block min-w-[150px]">{principalInfo.nama}</p><p className="mt-1">NIP. {principalInfo.nip}</p></div>
             <div className="text-center w-64"><p>{kota}, {new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p><p className="font-bold mb-20">Guru Yang Bersangkutan</p><p className="font-bold border-b border-black inline-block min-w-[150px]">{user.nama}</p><p className="mt-1">NIP. {user.nip}</p></div>
          </div>
        </div>
      );
    }

    // ==========================================
    // 4. FORM SCREEN (WITH CACHING & VALIDATION)
    // ==========================================

    function FormScreen({ user, onCancel, onSuccess, suggestionsKegiatan, suggestionsHasil, initialData, showToast }) {
      const [kegiatan, setKegiatan] = useState(initialData ? initialData.kegiatan : '');
      const [hasil, setHasil] = useState(initialData ? initialData.hasil : '');
      const [showDetail, setShowDetail] = useState(!!initialData); 
      const [jamMulai, setJamMulai] = useState(initialData ? initialData.jamMulai : '07:00');
      const [jamSelesai, setJamSelesai] = useState(initialData ? initialData.jamSelesai : '08:00');
      const [fotoPreview, setFotoPreview] = useState(initialData ? initialData.foto : null);
      const [isSubmitting, setIsSubmitting] = useState(false);
      const fotoLamaRef = useRef(initialData ? initialData.foto : null);
      const cameraInputRef = useRef(null);
      const fileInputRef = useRef(null);

      // Gunakan local storage sebagai fallback jika props kosong (Offline mode)
      const cachedKegiatan = suggestionsKegiatan.length > 0 ? suggestionsKegiatan : JSON.parse(localStorage.getItem('cache_kegiatan') || '[]');
      const cachedHasil = suggestionsHasil.length > 0 ? suggestionsHasil : JSON.parse(localStorage.getItem('cache_hasil') || '[]');
      
      const safeKegiatanList = cachedKegiatan.length > 0 ? cachedKegiatan : DEFAULT_KEGIATAN;
      const safeHasilList = cachedHasil.length > 0 ? cachedHasil : DEFAULT_HASIL;

      const filteredKegiatan = safeKegiatanList.filter(s => s && s.toLowerCase().includes((kegiatan || '').toLowerCase()));
      const filteredHasil = safeHasilList.filter(s => s && s.toLowerCase().includes((hasil || '').toLowerCase()));

      const handleFileChange = async (e) => {
        const file = e.target.files[0];
        if (file) {
          try {
            const compressedBase64 = await compressImage(file);
            setFotoPreview(compressedBase64);
          } catch (err) { showToast("Gagal memproses gambar", 'error'); }
        }
      };

      const handleSubmit = async () => {
        if (!kegiatan || !hasil) { showToast("Kegiatan dan Hasil wajib diisi!", 'error'); return; }
        setIsSubmitting(true);
        const dataJurnal = {
          id: initialData ? initialData.id : Date.now().toString(), 
          nip: user.nip, nama: user.nama, kegiatan, hasil, 
          jamMulai: showDetail ? jamMulai : null, jamSelesai: showDetail ? jamSelesai : null, 
          fotoBase64: (fotoPreview && fotoPreview.startsWith('data:')) ? fotoPreview : null,
          fotoLama: fotoLamaRef.current, action: initialData ? 'edit' : 'create'
        };
        try {
          const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify(dataJurnal) });
          const result = await response.json();
          if (result.success) { 
             const finalEntry = result.data || { ...dataJurnal, foto: fotoPreview }; 
             onSuccess(finalEntry); 
          } else { showToast("Gagal: " + result.message, 'error'); }
        } catch (err) { showToast("Gagal koneksi server.", 'error'); } finally { setIsSubmitting(false); }
      };

      return (
        <div className="h-full flex flex-col bg-white relative no-print">
          {isSubmitting && (
            <div className="absolute inset-0 z-50 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center">
               <div className="loader border-t-blue-600 w-10 h-10 mb-4"></div>
               <p className="font-bold text-gray-800">Sedang menyimpan...</p>
            </div>
          )}
          <div className="px-4 py-4 border-b border-gray-100 flex items-center justify-between bg-white z-20 sticky top-0">
            <button onClick={onCancel} className="text-sm font-medium text-gray-500 px-2 py-1 hover:bg-gray-100 rounded">Batal</button>
            <span className="font-bold text-gray-800">{initialData ? 'Edit Jurnal' : 'Tulis Jurnal'}</span>
            <button onClick={handleSubmit} className="text-sm font-bold text-blue-600 px-3 py-1 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">Simpan</button>
          </div>
          <div className="flex-1 overflow-y-auto p-5 pb-32 space-y-6">
              <div className="space-y-2">
                <div className="flex justify-between items-center"><label className="text-sm font-bold text-gray-700">Kegiatan <span className="text-red-500">*</span></label><VoiceInputButton onResult={t => setKegiatan(p => p ? p + " " + t : t)} /></div>
                <textarea value={kegiatan} onChange={e => setKegiatan(e.target.value)} placeholder="Apa kegiatan hari ini?" className="w-full p-4 bg-gray-50 border-0 rounded-2xl text-gray-800 text-base shadow-inner" rows={3}></textarea>
                {filteredKegiatan.length > 0 && <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">{filteredKegiatan.map((s,i)=><button key={i} onClick={()=>setKegiatan(s)} className="whitespace-nowrap px-3 py-1 bg-white border border-gray-200 rounded-full text-xs text-gray-600 shadow-sm hover:border-blue-300">{s.slice(0,30)}...</button>)}</div>}
              </div>
              <div className="space-y-2">
                <div className="flex justify-between items-center"><label className="text-sm font-bold text-gray-700">Hasil <span className="text-red-500">*</span></label><VoiceInputButton onResult={t => setHasil(p => p ? p + " " + t : t)} /></div>
                <textarea value={hasil} onChange={e => setHasil(e.target.value)} placeholder="Hasilnya bagaimana?" className="w-full p-4 bg-gray-50 border-0 rounded-2xl text-gray-800 text-base shadow-inner" rows={2}></textarea>
                {filteredHasil.length > 0 && <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">{filteredHasil.map((s,i)=><button key={i} onClick={()=>setHasil(s)} className="whitespace-nowrap px-3 py-1 bg-white border border-gray-200 rounded-full text-xs text-gray-600 shadow-sm hover:border-blue-300">{s.slice(0,30)}...</button>)}</div>}
              </div>
              <div className="py-2 text-center">
                 <button onClick={() => setShowDetail(!showDetail)} className="text-xs font-bold text-gray-400 uppercase flex items-center justify-center gap-1 mx-auto hover:text-blue-500">{showDetail ? 'Tutup Detail' : 'Detail Waktu & Foto'} <ChevronDown size={14} /></button>
              </div>
              {showDetail && (
                <div className="space-y-4 bg-gray-50 p-4 rounded-xl border border-gray-100 animate-in fade-in slide-in-from-top-2">
                   <div className="grid grid-cols-2 gap-4">
                      <div><label className="text-xs font-bold text-gray-500 uppercase">Mulai</label><input type="time" value={jamMulai} onChange={e => setJamMulai(e.target.value)} className="w-full bg-white p-2 rounded text-center border border-gray-200" /></div>
                      <div><label className="text-xs font-bold text-gray-500 uppercase">Selesai</label><input type="time" value={jamSelesai} onChange={e => setJamSelesai(e.target.value)} className="w-full bg-white p-2 rounded text-center border border-gray-200" /></div>
                   </div>
                   <div>
                      <label className="text-xs font-bold text-gray-500 uppercase block mb-2">Foto Dokumentasi</label>
                      {!fotoPreview ? (
                         <div className="grid grid-cols-2 gap-3">
                            <button onClick={() => cameraInputRef.current.click()} className="h-24 bg-blue-100 text-blue-600 rounded-xl flex flex-col items-center justify-center hover:bg-blue-200 transition"><Camera size={24} /><span className="text-xs font-bold mt-1">Kamera</span></button>
                            <button onClick={() => fileInputRef.current.click()} className="h-24 bg-gray-200 text-gray-600 rounded-xl flex flex-col items-center justify-center hover:bg-gray-300 transition"><Image size={24} /><span className="text-xs font-bold mt-1">Galeri</span></button>
                            <input type="file" ref={cameraInputRef} className="hidden" accept="image/*" capture="environment" onChange={handleFileChange} />
                            <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileChange} />
                         </div>
                      ) : (
                         <div className="relative"><img src={fotoPreview} className="w-full h-40 object-cover rounded-xl shadow-md" /><button onClick={()=>setFotoPreview(null)} className="absolute top-2 right-2 bg-red-600 text-white p-1 rounded-full shadow-lg hover:scale-110 transition"><X size={16}/></button></div>
                      )}
                   </div>
                </div>
              )}
          </div>
          <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-100 md:hidden z-30">
             <button onClick={handleSubmit} disabled={isSubmitting} className="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg flex items-center justify-center gap-2 hover:bg-blue-700 active:scale-95 transition">
                {isSubmitting ? <Loader2 className="animate-spin" size={18} /> : <Save size={18} />} {initialData ? 'Update Jurnal' : 'Simpan Jurnal'}
              </button>
          </div>
        </div>
      );
    }

    // ==========================================
    // 5. FITUR ADMIN LENGKAP
    // ==========================================

    function AdminMonitor() {
      const [data, setData] = useState([]);
      const [loading, setLoading] = useState(true);
      useEffect(() => {
        fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'admin_get_all_jurnals' }) })
        .then(r => r.json()).then(j => { if(j.success) setData(j.jurnals || []); setLoading(false); })
        .catch(e => setLoading(false));
      }, []);
      if (loading) return <div className="p-4 text-center"><Loader2 className="animate-spin inline text-blue-500"/></div>;
      return (
        <div className="space-y-3">
           <h3 className="font-bold text-gray-700 flex items-center gap-2"><List size={18}/> Monitor Realtime</h3>
           {data.length === 0 ? <p className="text-sm text-gray-400 bg-white p-4 rounded text-center">Belum ada aktivitas.</p> : data.map((j, i) => (
             <div key={i} className="bg-white p-3 rounded-lg border-l-4 border-blue-500 shadow-sm">
               <div className="flex justify-between items-center mb-1"><span className="font-bold text-gray-800 text-sm">{j.nama}</span><span className="text-[10px] bg-gray-100 px-2 py-0.5 rounded text-gray-500">{new Date(parseInt(j.id)).toLocaleDateString()}</span></div>
               <p className="text-sm text-gray-600 line-clamp-2">{j.kegiatan}</p>
             </div>
           ))}
        </div>
      );
    }

    function AdminStats() {
      const [stats, setStats] = useState([]);
      useEffect(() => {
        fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'admin_get_stats' }) })
        .then(r => r.json()).then(j => { if(j.success) setStats(j.stats || []); });
      }, []);
      
      const maxCount = Math.max(...stats.map(s => s.count), 1);
      
      return (
        <div className="space-y-4">
          <h3 className="font-bold text-gray-700 flex items-center gap-2"><BarChart2 size={18}/> Statistik Keaktifan</h3>
          {stats.map((s, i) => {
            const percentage = (s.count / maxCount) * 100;
            return (
              <div key={i} className="bg-white p-3 rounded border border-gray-100">
                 <div className="flex justify-between text-sm mb-1">
                   <span className="font-bold text-gray-700">{s.name}</span>
                   <span className="text-blue-600 font-bold">{s.count}</span>
                 </div>
                 <div className="w-full bg-gray-100 rounded-full h-2.5">
                    <div className="bg-blue-600 h-2.5 rounded-full transition-all duration-1000 ease-out" style={{ width: `${percentage}%` }}></div>
                 </div>
              </div>
            );
          })}
        </div>
      );
    }

    function AdminUsers({ showToast }) {
      const [users, setUsers] = useState([]);
      const [form, setForm] = useState(null); 
      const reload = () => fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'admin_get_users' }) }).then(r=>r.json()).then(j=>setUsers(j.users || []));
      useEffect(() => { reload(); }, []);
      
      const save = async () => {
         if(!form.nip || !form.nama) return showToast("NIP dan Nama wajib!", "error");
         await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'admin_save_user', user: form }) });
         setForm(null); reload(); showToast("Data Guru disimpan", "success");
      }
      
      const delUser = async (nip) => {
         if(!confirm("Hapus guru ini? Data jurnal mereka mungkin error.")) return;
         await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'admin_delete_user', nip }) });
         reload(); showToast("Guru dihapus", "success");
      }
      
      return (
        <div className="space-y-3">
          <div className="flex justify-between items-center"><h3 className="font-bold text-gray-700 flex items-center gap-2"><Users size={18}/> Manajemen Guru</h3><button onClick={()=>setForm({nip:'',nama:'',pin:'',role:'Guru',sekolah:''})} className="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg font-bold flex gap-1 items-center"><Plus size={12}/> Tambah</button></div>
          {form && (
            <div className="bg-blue-50 p-4 rounded-xl space-y-3 border border-blue-200 shadow-inner mb-4 animate-in fade-in">
               <h4 className="font-bold text-blue-800 text-xs uppercase">Input Data Guru</h4>
               <input className="w-full p-2 border rounded text-sm" placeholder="NIP (Unik)" value={form.nip} onChange={e=>setForm({...form, nip:e.target.value})} />
               <input className="w-full p-2 border rounded text-sm" placeholder="Nama Lengkap" value={form.nama} onChange={e=>setForm({...form, nama:e.target.value})} />
               <div className="grid grid-cols-2 gap-2">
                 <input className="w-full p-2 border rounded text-sm" placeholder="PIN Login" value={form.pin} onChange={e=>setForm({...form, pin:e.target.value})} />
                 <select className="w-full p-2 border rounded text-sm" value={form.role} onChange={e=>setForm({...form, role:e.target.value})}>
                    <option value="Guru">Guru</option><option value="Kepala Sekolah">Kepala Sekolah</option><option value="Admin">Admin</option>
                 </select>
               </div>
               <input className="w-full p-2 border rounded text-sm" placeholder="Nama Sekolah" value={form.sekolah} onChange={e=>setForm({...form, sekolah:e.target.value})} />
               <div className="flex gap-2 pt-2"><button onClick={save} className="flex-1 bg-blue-600 text-white py-2 rounded-lg text-xs font-bold shadow">SIMPAN</button><button onClick={()=>setForm(null)} className="flex-1 bg-gray-300 py-2 rounded-lg text-xs font-bold text-gray-600">BATAL</button></div>
            </div>
          )}
          {users.map((u,i)=>(
            <div key={i} className="bg-white p-3 rounded-lg border border-gray-100 flex justify-between items-center shadow-sm">
               <div><p className="text-sm font-bold text-gray-800">{u.nama}</p><p className="text-xs text-gray-500">{u.nip} • {u.role}</p></div>
               <div className="flex gap-2">
                  <button onClick={()=>setForm(u)} className="p-1.5 bg-blue-50 text-blue-600 rounded"><Pencil size={14}/></button>
                  <button onClick={()=>delUser(u.nip)} className="p-1.5 bg-red-50 text-red-600 rounded"><Trash2 size={14}/></button>
               </div>
            </div>
          ))}
        </div>
      );
    }

    function AdminRefs({ defaultKegiatan, defaultHasil, defaultKota, showToast }) {
       const [kegiatan, setKegiatan] = useState(defaultKegiatan || []);
       const [hasil, setHasil] = useState(defaultHasil || []);
       const [kota, setKota] = useState(defaultKota || "");
       const [temp, setTemp] = useState("");
       const [mode, setMode] = useState('kegiatan');
       
       const add = () => { if(temp) { if(mode==='kegiatan') setKegiatan([...kegiatan,temp]); else setHasil([...hasil,temp]); setTemp(""); } };
       const del = (i) => { if(mode==='kegiatan') setKegiatan(kegiatan.filter((_,idx)=>idx!==i)); else setHasil(hasil.filter((_,idx)=>idx!==i)); };
       const save = async () => {
          await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'admin_update_ref', type: 'kegiatan', items: kegiatan }) });
          await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'admin_update_ref', type: 'hasil', items: hasil }) });
          await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'admin_save_city', kota }) });
          // Update Cache Admin juga
          localStorage.setItem('cache_kegiatan', JSON.stringify(kegiatan));
          localStorage.setItem('cache_hasil', JSON.stringify(hasil));
          showToast("Referensi & Kota Disimpan", "success");
       };

       return (
         <div className="space-y-4">
            <div className="bg-white p-3 rounded border border-gray-100">
               <label className="text-xs font-bold text-gray-500 uppercase">Kota Laporan (Untuk TTD)</label>
               <input value={kota} onChange={e=>setKota(e.target.value)} className="w-full border-b-2 border-blue-100 focus:border-blue-500 outline-none py-1 text-sm font-bold text-gray-800"/>
            </div>
            <div className="flex gap-2 bg-gray-200 p-1 rounded-lg">
               <button onClick={()=>setMode('kegiatan')} className={`flex-1 py-1.5 rounded-md text-xs font-bold transition-all ${mode==='kegiatan'?'bg-white shadow text-blue-600':'text-gray-500'}`}>Kegiatan</button>
               <button onClick={()=>setMode('hasil')} className={`flex-1 py-1.5 rounded-md text-xs font-bold transition-all ${mode==='hasil'?'bg-white shadow text-green-600':'text-gray-500'}`}>Hasil</button>
            </div>
            <div className="flex gap-2">
               <input value={temp} onChange={e=>setTemp(e.target.value)} placeholder={`Tambah ${mode}...`} className="flex-1 border p-2 rounded text-sm"/>
               <button onClick={add} className="bg-gray-800 text-white px-3 rounded"><Plus size={16}/></button>
            </div>
            <div className="bg-white rounded-xl border border-gray-100 max-h-60 overflow-y-auto shadow-inner p-2">
               {(mode==='kegiatan' ? kegiatan : hasil).map((item,i)=>(
                 <div key={i} className="p-2 border-b last:border-0 flex justify-between items-center text-sm">
                    <span>{item}</span>
                    <button onClick={()=>del(i)} className="text-red-400 hover:text-red-600"><X size={14}/></button>
                 </div>
               ))}
            </div>
            <button onClick={save} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition">Simpan Perubahan</button>
         </div>
       );
    }

    function AdminBackup() {
      const [loading, setLoading] = useState(false);
      const handleBackup = async () => {
        setLoading(true);
        try {
           const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'admin_backup_data' }) });
           const json = await res.json();
           if(json.success) {
              const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(json.data));
              const downloadAnchorNode = document.createElement('a');
              downloadAnchorNode.setAttribute("href", dataStr);
              downloadAnchorNode.setAttribute("download", "backup_jurnal_guru_" + Date.now() + ".json");
              document.body.appendChild(downloadAnchorNode);
              downloadAnchorNode.click();
              downloadAnchorNode.remove();
           }
        } catch(e) { alert("Backup Gagal"); } finally { setLoading(false); }
      }
      return (
         <div className="bg-white p-4 rounded-xl border border-gray-100 space-y-2">
            <h3 className="font-bold text-gray-700 flex items-center gap-2"><Database size={18}/> Backup Data</h3>
            <p className="text-xs text-gray-500">Download data mentah guru dalam format JSON untuk arsip.</p>
            <button onClick={handleBackup} disabled={loading} className="w-full bg-gray-800 text-white py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2">{loading ? <Loader2 className="animate-spin"/> : <Download size={16}/>} Download Backup</button>
         </div>
      );
    }

    function AdminDashboard({ user, onLogout, showToast, onBackToApp, refData }) {
      const [tab, setTab] = useState('stats');
      return (
        <div className="h-full flex flex-col bg-gray-50">
           <div className="bg-gray-900 text-white p-6 pt-10 sticky top-0 z-20 shadow-lg">
              <div className="flex justify-between items-center mb-6">
                 <button onClick={onBackToApp} className="p-2 bg-gray-800 rounded-full hover:bg-gray-700"><ArrowLeft size={18}/></button>
                 <h2 className="text-lg font-bold">Admin Panel</h2>
                 <button onClick={onLogout} className="bg-red-600 p-2 rounded hover:bg-red-700"><LogOut size={16}/></button>
              </div>
              <div className="flex gap-2 text-xs font-bold overflow-x-auto no-scrollbar pb-1">
                 {['stats','monitor','users','refs'].map(t => (
                   <button key={t} onClick={()=>setTab(t)} className={`px-4 py-2 rounded-full capitalize transition-all whitespace-nowrap ${tab===t ? 'bg-blue-600 text-white shadow-lg scale-105' : 'bg-gray-800 text-gray-400'}`}>{t}</button>
                 ))}
              </div>
           </div>
           <div className="flex-1 overflow-y-auto p-4 space-y-6">
              {tab === 'stats' && <><AdminStats /><AdminBackup/></>}
              {tab === 'monitor' && <AdminMonitor />}
              {tab === 'users' && <AdminUsers showToast={showToast} />}
              {tab === 'refs' && <AdminRefs defaultKegiatan={refData.kegiatan} defaultHasil={refData.hasil} defaultKota={refData.kota} showToast={showToast} />}
           </div>
        </div>
      );
    }

    // ==========================================
    // 6. MAIN SCREEN (HOME / REKAP / PROFILE)
    // ==========================================
    
    function HomeTab({ user, entries = [], onEdit, onDelete, isLoadingJurnal }) {
      const [viewMode, setViewMode] = useState('list');
      const [selectedDate, setSelectedDate] = useState(new Date());
      const displayEntries = viewMode === 'list' 
        ? entries.filter(e => new Date(parseInt(e.id)).toDateString() === new Date().toDateString())
        : entries.filter(e => new Date(parseInt(e.id)).toDateString() === selectedDate.toDateString());
        
      return (
        <div>
           <div className="bg-white px-6 pt-10 pb-4 shadow-sm sticky top-0 z-10">
              <div className="flex justify-between items-center mb-4">
                 <div><h2 className="text-xl font-bold text-gray-900">Halo, {user.nama.split(' ')[0]}</h2><p className="text-xs text-gray-500">Semangat Mengajar!</p></div>
                 <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center font-bold text-blue-600 shadow-sm border border-blue-200">{user.nama[0]}</div>
              </div>
              <div className="flex bg-gray-100 p-1 rounded-xl">
                 <button onClick={()=>setViewMode('list')} className={`flex-1 py-1.5 text-xs font-bold rounded-lg transition-all ${viewMode==='list'?'bg-white shadow text-blue-600':'text-gray-500'}`}>Hari Ini</button>
                 <button onClick={()=>setViewMode('calendar')} className={`flex-1 py-1.5 text-xs font-bold rounded-lg transition-all ${viewMode==='calendar'?'bg-white shadow text-blue-600':'text-gray-500'}`}>Kalender</button>
              </div>
           </div>
           <div className="p-4 space-y-3 pb-24">
              {viewMode === 'calendar' && <CalendarView entries={entries} selectedDate={selectedDate} onSelectDate={setSelectedDate} />}
              {isLoadingJurnal ? <div className="text-center py-10"><Loader2 className="animate-spin inline text-blue-500"/></div> : 
               displayEntries.length === 0 ? <div className="text-center py-12 flex flex-col items-center opacity-50"><div className="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mb-3"><FileText size={24} className="text-gray-400"/></div><p className="text-sm font-bold text-gray-400">Belum ada jurnal.</p></div> : 
               displayEntries.map(e => (
                 <div key={e.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-[0_2px_8px_rgba(0,0,0,0.04)] relative group">
                    <div className="flex justify-between items-start mb-1">
                       <h4 className="font-bold text-sm text-gray-800 line-clamp-1">{e.kegiatan}</h4>
                       <div className="flex gap-2">
                          <button onClick={()=>onEdit(e)} className="text-gray-400 hover:text-blue-600 p-1"><Pencil size={14}/></button>
                          <button onClick={()=>onDelete(e.id)} className="text-gray-400 hover:text-red-600 p-1"><Trash2 size={14}/></button>
                       </div>
                    </div>
                    <p className="text-xs text-gray-500 mb-2 line-clamp-2">{e.hasil}</p>
                    <div className="flex items-center gap-2 text-[10px] text-gray-500 font-medium">
                       <div className="flex items-center gap-1 bg-gray-50 px-2 py-1 rounded"><Clock size={10}/> {e.jamMulai} - {e.jamSelesai}</div>
                       {e.foto && <div className="flex items-center gap-1 text-blue-600 bg-blue-50 px-2 py-1 rounded"><Image size={10}/> Foto</div>}
                    </div>
                 </div>
               ))
              }
           </div>
        </div>
      );
    }

    function RekapTab({ user, entries = [] }) {
      const downloadCSV = () => {
         let csv = "Tanggal,Nama,Kegiatan,Hasil\n" + entries.map(e=>`${new Date(parseInt(e.id)).toLocaleDateString()},${user.nama},"${e.kegiatan}","${e.hasil}"`).join("\n");
         const link = document.createElement("a"); link.href = "data:text/csv;charset=utf-8,"+encodeURI(csv); link.download="Jurnal.csv"; link.click();
      };
      return (
         <div className="p-6 pt-10 space-y-6">
            <h2 className="text-2xl font-bold text-gray-900">Rekapitulasi</h2>
            <div className="bg-gradient-to-br from-blue-600 to-blue-500 text-white p-5 rounded-2xl shadow-xl relative overflow-hidden">
               <p className="text-xs text-blue-100 font-medium uppercase tracking-wider">Total Jurnal Anda</p>
               <p className="text-5xl font-bold mt-1">{entries.length}</p>
               <FileText className="absolute -bottom-4 -right-4 w-32 h-32 text-white/10 rotate-12" />
            </div>
            <div className="grid grid-cols-2 gap-3">
               <button onClick={()=>window.print()} className="bg-gray-900 active:bg-black text-white py-3 rounded-xl text-xs font-bold flex flex-col items-center justify-center gap-2 shadow-lg"><Printer size={20}/> Cetak PDF</button>
               <button onClick={downloadCSV} className="bg-green-600 active:bg-green-700 text-white py-3 rounded-xl text-xs font-bold flex flex-col items-center justify-center gap-2 shadow-lg"><FileSpreadsheet size={20}/> Download Excel</button>
            </div>
            <div className="bg-yellow-50 border border-yellow-100 p-4 rounded-xl flex gap-3 items-start">
               <div className="p-1 bg-yellow-100 rounded text-yellow-600 mt-0.5"><AlertCircle size={16}/></div>
               <div><p className="text-xs font-bold text-gray-800">Tips Cetak</p><p className="text-[10px] text-gray-600">Gunakan layout "Landscape" di pengaturan printer HP/Laptop Anda agar tabel tidak terpotong.</p></div>
            </div>
         </div>
      );
    }

    function ProfileTab({ user, onLogout, onOpenAdmin }) {
      return (
        <div className="bg-gray-50 h-full">
           <div className="bg-white pt-10 pb-8 rounded-b-[40px] shadow-sm text-center px-6 relative z-10">
              <div className="w-24 h-24 bg-blue-100 text-blue-600 rounded-full mx-auto flex items-center justify-center text-4xl font-bold mb-4 border-4 border-blue-50">{user.nama[0]}</div>
              <h2 className="font-bold text-xl text-gray-900">{user.nama}</h2>
              <p className="text-sm text-gray-500 font-mono mt-1">{user.nip}</p>
              <div className="flex justify-center mt-3 gap-2">
                 <span className="bg-blue-600 text-white px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider shadow-sm">{user.role}</span>
                 <span className="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider">{user.sekolah}</span>
              </div>
           </div>
           <div className="p-6 space-y-3 mt-4">
              {(user.role === 'Admin' || user.role === 'Kepala Sekolah') && (
                 <button onClick={onOpenAdmin} className="w-full flex items-center gap-4 p-4 bg-white rounded-2xl shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-gray-100 hover:bg-gray-50 transition"><div className="p-2 bg-blue-100 text-blue-600 rounded-lg"><ShieldCheck size={20}/></div><span className="text-sm font-bold flex-1 text-left text-gray-700">Admin Panel</span><ChevronRight size={16} className="text-gray-400"/></button>
              )}
              <button onClick={onLogout} className="w-full flex items-center gap-4 p-4 bg-white rounded-2xl shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-gray-100 text-red-600 hover:bg-red-50 transition"><div className="p-2 bg-red-100 rounded-lg"><LogOut size={20}/></div><span className="text-sm font-bold flex-1 text-left">Keluar Akun</span></button>
           </div>
        </div>
      );
    }

    function LoginScreen({ onLogin, showToast }) {
      const [pin, setPin] = useState('');
      const [loading, setLoading] = useState(false);
      const submit = async (e) => {
         e.preventDefault(); setLoading(true);
         try {
            const res = await fetch(APPS_SCRIPT_URL, {method:'POST', body:JSON.stringify({action:'login', pin})});
            const json = await res.json();
            if(json.success) onLogin(json.user); else showToast(json.message, 'error');
         } catch(e){ showToast("Error koneksi internet", 'error'); } finally { setLoading(false); }
      };
      return (
         <div className="min-h-screen bg-blue-600 flex flex-col items-center justify-center p-8 text-white no-print relative overflow-hidden">
            <div className="absolute top-0 left-0 w-64 h-64 bg-white/10 rounded-full blur-3xl -translate-x-1/2 -translate-y-1/2"></div>
            <div className="absolute bottom-0 right-0 w-64 h-64 bg-black/10 rounded-full blur-3xl translate-x-1/2 translate-y-1/2"></div>
            
            <div className="bg-white/20 p-5 rounded-3xl mb-6 backdrop-blur-md shadow-2xl border border-white/20 relative z-10"><BookOpen size={48} className="drop-shadow-md"/></div>
            <h1 className="text-3xl font-bold mb-1 relative z-10">Jurnal Guru</h1>
            <p className="text-blue-200 text-sm mb-10 relative z-10">Versi Mobile App v2.0</p>
            
            <form onSubmit={submit} className="w-full max-w-xs bg-white/10 p-8 rounded-3xl backdrop-blur-md border border-white/20 shadow-2xl relative z-10">
               <label className="text-xs font-bold text-blue-100 uppercase block mb-3 text-center tracking-widest">PIN Keamanan</label>
               <input type="password" value={pin} onChange={e=>setPin(e.target.value)} disabled={loading} className="w-full bg-black/20 border-0 rounded-xl text-center text-3xl py-4 tracking-[0.5em] text-white placeholder-white/30 focus:ring-2 focus:ring-white/50 mb-6 transition-all" placeholder="••••••" autoFocus inputMode="numeric" />
               <button disabled={loading} className="w-full bg-white text-blue-600 font-bold py-4 rounded-xl hover:bg-blue-50 active:scale-95 transition-all disabled:opacity-70 shadow-lg">
                  {loading ? 'Memverifikasi...' : 'MASUK SEKARANG'}
               </button>
            </form>
         </div>
      );
    }

    function MainScreen({ user, entries, onLogout, onAdd, onEdit, onDelete, onOpenAdmin, principalInfo, kota, isLoadingJurnal }) {
      const [tab, setTab] = useState('home');
      return (
        <div className="h-full flex flex-col bg-gray-50">
           <div className="flex-1 overflow-y-auto no-print scroll-smooth">
              {tab === 'home' && <HomeTab user={user} entries={entries} onEdit={onEdit} onDelete={onDelete} isLoadingJurnal={isLoadingJurnal} />}
              {tab === 'rekap' && <RekapTab user={user} entries={entries} />}
              {tab === 'profile' && <ProfileTab user={user} onLogout={onLogout} onOpenAdmin={onOpenAdmin} />}
           </div>
           {tab === 'home' && <button onClick={onAdd} className="fixed bottom-24 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-xl flex items-center justify-center z-20 no-print hover:scale-105 active:scale-90 transition-transform"><Plus size={28}/></button>}
           <div className="bg-white border-t border-gray-100 p-2 pb-6 md:pb-2 flex justify-around no-print shadow-[0_-5px_10px_rgba(0,0,0,0.02)] z-30 fixed bottom-0 left-0 right-0 md:relative">
              <NavButton icon={<Home size={22}/>} label="Beranda" active={tab==='home'} onClick={()=>setTab('home')}/>
              <NavButton icon={<BarChart2 size={22}/>} label="Rekap" active={tab==='rekap'} onClick={()=>setTab('rekap')}/>
              <NavButton icon={<User size={22}/>} label="Profil" active={tab==='profile'} onClick={()=>setTab('profile')}/>
           </div>
           <PrintableReport user={user} entries={entries} principalInfo={principalInfo} kota={kota} />
        </div>
      );
    }

    // ==========================================
    // 7. APP CONTROLLER (LOGIC PUSAT)
    // ==========================================

    function App() {
      const [view, setView] = useState('login');
      const [user, setUser] = useState(null);
      const [entries, setEntries] = useState([]);
      const [editData, setEditData] = useState(null);
      const [refData, setRefData] = useState({ kegiatan: [], hasil: [], kota: "Jakarta" });
      const [loadingJurnal, setLoadingJurnal] = useState(false);
      const [principal, setPrincipal] = useState({ nama: '...', nip: '...' });
      const [toast, setToast] = useState(null);

      const showToast = (msg, type='info') => setToast({ msg, type, id: Date.now() });

      // Init Load
      useEffect(() => {
         const u = localStorage.getItem('user');
         if(u) { const p = JSON.parse(u); setUser(p); setView('main'); fetchJurnal(p.nip); }
         
         // Fetch Global Data (Refs & Principal)
         fetch(APPS_SCRIPT_URL + "?api=true&action=get_refs").then(r=>r.json()).then(j=>{ 
            setRefData({ 
                kegiatan: Array.isArray(j.kegiatan) ? j.kegiatan : [], 
                hasil: Array.isArray(j.hasil) ? j.hasil : [], 
                kota: j.kota || "Jakarta" 
            });
            // Update Local Storage Cache
            if(j.kegiatan?.length) localStorage.setItem('cache_kegiatan', JSON.stringify(j.kegiatan));
            if(j.hasil?.length) localStorage.setItem('cache_hasil', JSON.stringify(j.hasil));
         }).catch(e => console.log('Ref error, using cache'));

         fetch(APPS_SCRIPT_URL, {method:'POST',body:JSON.stringify({action:'get_principal_info'})}).then(r=>r.json()).then(j=>{ if(j.success) setPrincipal({nama:j.nama, nip:j.nip}) });
      }, []);

      const fetchJurnal = (nip) => {
         setLoadingJurnal(true);
         fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'get_user_jurnals', nip }) })
           .then(r => r.json()).then(j => { if(j.success) setEntries(j.jurnals || []); }) 
           .finally(() => setLoadingJurnal(false));
      };

      const handleLogin = (u) => { setUser(u); localStorage.setItem('user', JSON.stringify(u)); setView('main'); fetchJurnal(u.nip); };
      const handleLogout = () => { setUser(null); localStorage.removeItem('user'); setEntries([]); setView('login'); };
      
      const handleSave = (newEntry) => {
         if(editData) setEntries(entries.map(e => e.id === newEntry.id ? newEntry : e));
         else setEntries([newEntry, ...entries]);
         setEditData(null); setView('main'); showToast("Data Berhasil Disimpan", "success");
      };
      
      const handleDelete = async (id) => {
         if(!confirm("Yakin ingin menghapus jurnal ini?")) return;
         setEntries(entries.filter(e => e.id !== id));
         await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', id }) });
         showToast("Data Dihapus", "success");
      };

      return (
        <div className="max-w-md mx-auto min-h-screen bg-gray-50 shadow-2xl overflow-hidden relative print:max-w-none print:shadow-none print:overflow-visible">
           {toast && <Toast message={toast.msg} type={toast.type} onClose={()=>setToast(null)} />}
           
           {view === 'login' && <LoginScreen onLogin={handleLogin} showToast={showToast} />}
           
           {view === 'main' && user && (
              <MainScreen 
                user={user} 
                entries={entries} 
                isLoadingJurnal={loadingJurnal}
                onLogout={handleLogout} 
                onAdd={()=>{setEditData(null); setView('form');}} 
                onEdit={(e)=>{setEditData(e); setView('form');}}
                onDelete={handleDelete}
                onOpenAdmin={()=>setView('admin')}
                principalInfo={principal}
                kota={refData.kota}
              />
           )}
           
           {view === 'form' && user && (
              <FormScreen 
                 user={user} 
                 initialData={editData} 
                 onCancel={()=>setView('main')} 
                 onSuccess={handleSave}
                 suggestionsKegiatan={refData.kegiatan}
                 suggestionsHasil={refData.hasil}
                 showToast={showToast}
              />
           )}

           {view === 'admin' && user && (
              <AdminDashboard 
                 user={user} 
                 onLogout={handleLogout} 
                 showToast={showToast} 
                 onBackToApp={()=>setView('main')} 
                 refData={refData}
              />
           )}
        </div>
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);

  </script>
</body>
</html>
