<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jurnal Guru Mobile</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#9c4100',
                        onPrimary: '#ffffff',
                        primaryContainer: '#ffdbc8',
                        onPrimaryContainer: '#341100',
                        secondary: '#77574e',
                        secondaryContainer: '#ffdbcc',
                        onSecondaryContainer: '#2c160f',
                        surface: '#fff8f6',
                        onSurface: '#201a18',
                        surfaceVariant: '#f5ded5',
                        onSurfaceVariant: '#53433f',
                        outline: '#85736b',
                        error: '#ba1a1a',
                    },
                    fontFamily: {
                        sans: ['Roboto', 'Segoe UI', 'sans-serif'],
                        serif: ['Times New Roman', 'serif'],
                    },
                    borderRadius: {
                        '4xl': '28px',
                    }
                }
            }
        }
    </script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- HTML2PDF for AppCreator24 Compatibility -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* PDF Generator Style */
        #report-container {
            background: white;
            color: black;
            font-family: 'Times New Roman', serif;
            padding: 20px;
            width: 100%;
        }
        
        /* Helpers */
        .hidden-view { display: none !important; }
        input, textarea, select { font-size: 16px; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Calendar UI */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 999px; font-size: 0.85rem; cursor: pointer; position: relative; transition: all 0.2s; color: #201a18; }
        .calendar-day.has-data::after { content: ''; width: 5px; height: 5px; background-color: #9c4100; border-radius: 50%; position: absolute; bottom: 4px; }
        .calendar-day.selected { background-color: #9c4100; color: white; }
        .calendar-day.selected.has-data::after { background-color: #ffdbc8; }
        .calendar-day.today { border: 1px solid #9c4100; color: #9c4100; }
        
        /* Suggestion List Style */
        .suggestion-list {
            max-height: 150px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: absolute;
            width: 100%;
            z-index: 50;
            top: 100%; /* Below input */
        }
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        .suggestion-item:hover { background-color: #f5ded5; }
        
        /* Camera UI fixes */
        video { object-fit: cover; }
    </style>
</head>
<body class="bg-surface text-onSurface min-h-screen relative font-sans selection:bg-primaryContainer selection:text-onPrimaryContainer">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden-view fixed inset-0 bg-surface/90 z-[70] flex items-center justify-center flex-col">
        <div class="animate-spin text-primary mb-4">
            <i data-lucide="loader-2" width="48" height="48"></i>
        </div>
        <p class="text-onSurfaceVariant font-medium tracking-wide">Memproses data...</p>
    </div>

    <!-- Image Modal Viewer -->
    <div id="modal-image" class="hidden-view fixed inset-0 bg-black/95 z-[60] flex flex-col items-center justify-center p-4">
        <button onclick="app.closeImage()" class="absolute top-4 right-4 w-10 h-10 bg-white/10 rounded-full flex items-center justify-center text-white z-20">
            <i data-lucide="x" width="24" height="24"></i>
        </button>
        <img id="modal-img-display" src="" class="max-w-full max-h-screen object-contain rounded-lg shadow-2xl" crossorigin="anonymous" referrerpolicy="no-referrer">
        <p class="text-white/70 mt-4 text-sm">Dokumentasi Kegiatan</p>
    </div>

    <!-- IN-APP CAMERA MODAL -->
    <div id="modal-camera" class="hidden-view fixed inset-0 bg-black z-[80] flex flex-col">
        <div class="relative flex-grow bg-black flex items-center justify-center overflow-hidden">
             <!-- Video element for stream with attributes for Android WebView -->
             <video id="camera-stream" autoplay playsinline muted class="w-full h-full object-cover"></video>
             
             <!-- Hidden canvas for capturing -->
             <canvas id="camera-canvas" class="hidden-view"></canvas>
             
             <!-- Guides -->
             <div class="absolute inset-0 border-2 border-white/30 pointer-events-none m-8 rounded-lg"></div>
        </div>
        
        <div class="h-32 bg-black flex items-center justify-between px-8 pb-4">
            <button onclick="app.stopCamera()" class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center text-white">
                <i data-lucide="x" width="24" height="24"></i>
            </button>
            
            <button onclick="app.takePicture()" class="w-20 h-20 rounded-full bg-white border-4 border-gray-300 flex items-center justify-center active:scale-95 transition shadow-lg">
                <div class="w-16 h-16 rounded-full bg-white border-2 border-black"></div>
            </button>
            
            <button onclick="app.switchCamera()" class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center text-white">
                <i data-lucide="refresh-cw" width="24" height="24"></i>
            </button>
        </div>
    </div>

    <!-- VIEW: LOGIN -->
    <div id="view-login" class="min-h-screen flex flex-col items-center justify-center p-6 bg-surface relative overflow-hidden">
        <div class="absolute top-[-10%] right-[-10%] w-64 h-64 bg-primaryContainer rounded-full blur-[80px] opacity-60 pointer-events-none"></div>
        <div class="absolute bottom-[-10%] left-[-10%] w-80 h-80 bg-secondaryContainer rounded-full blur-[80px] opacity-60 pointer-events-none"></div>

        <div class="w-full max-w-sm flex flex-col items-center z-10">
            <div class="mb-8 p-6 bg-primaryContainer rounded-[28px] text-onPrimaryContainer shadow-sm">
                <i data-lucide="book-open-check" width="48" height="48"></i>
            </div>
            
            <h1 class="text-4xl font-normal text-onSurface mb-2">Selamat Datang</h1>
            <p class="text-onSurfaceVariant text-lg mb-12">Jurnal Guru Mobile</p>
            
            <div id="login-error" class="hidden-view w-full mb-4 p-4 bg-error/10 text-error rounded-xl text-sm flex items-center gap-3">
                <i data-lucide="alert-circle" width="20" height="20"></i> <span id="login-error-text"></span>
            </div>
            
            <form id="form-login" class="w-full space-y-6">
                <div class="relative group">
                    <input type="password" id="login-pin" inputmode="numeric" maxlength="6" required 
                           class="peer w-full h-16 px-4 bg-surfaceVariant/50 rounded-t-xl border-b-2 border-onSurfaceVariant focus:border-primary text-center text-3xl tracking-[0.5em] font-medium text-onSurface placeholder-transparent focus:outline-none transition-colors" 
                           placeholder="PIN">
                    <label class="absolute left-0 top-0 w-full h-full flex items-center justify-center text-onSurfaceVariant text-lg transition-all peer-placeholder-shown:text-lg peer-focus:text-xs peer-focus:-translate-y-4 pointer-events-none opacity-50">
                        Masukkan PIN
                    </label>
                </div>
                
                <button type="submit" class="w-full h-14 bg-primary text-onPrimary rounded-full font-medium text-lg shadow-md hover:shadow-lg transition active:bg-primary/90 ripple flex items-center justify-center gap-2">
                    Masuk Aplikasi
                    <i data-lucide="arrow-right" width="20" height="20"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- VIEW: DASHBOARD -->
    <div id="view-dashboard" class="hidden-view pb-28 px-4 max-w-2xl mx-auto min-h-screen flex flex-col">
        <div class="pt-4 pb-2 flex justify-between items-center bg-surface sticky top-0 z-30">
            <div class="w-10 h-10 rounded-full bg-primaryContainer text-onPrimaryContainer flex items-center justify-center font-bold text-lg">
                <span id="user-initial">G</span>
            </div>
            <span class="text-lg font-medium text-onSurface">Jurnal Guru</span>
            <div class="w-10 h-10"></div> 
        </div>

        <div class="py-6">
            <h1 class="text-3xl font-normal text-onSurface">Halo, <span id="user-name" class="font-medium">Guru</span></h1>
            <p class="text-onSurfaceVariant mt-1" id="user-school">Unit Kerja</p>
        </div>
        
        <div class="flex gap-3 overflow-x-auto hide-scroll mb-6 pb-2">
            <div class="relative min-w-[140px]">
                <select id="filter-month" class="w-full appearance-none bg-surfaceVariant text-onSurfaceVariant pl-4 pr-10 py-2 rounded-lg text-sm font-medium focus:outline-none focus:ring-2 focus:ring-primary"></select>
                <i data-lucide="chevron-down" width="16" height="16" class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-onSurfaceVariant"></i>
            </div>
            <div class="relative min-w-[100px]">
                <select id="filter-year" class="w-full appearance-none bg-surface border border-outline text-onSurface pl-4 pr-10 py-2 rounded-lg text-sm font-medium focus:outline-none focus:ring-2 focus:ring-primary"></select>
                <i data-lucide="chevron-down" width="16" height="16" class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-onSurfaceVariant"></i>
            </div>
        </div>

        <div class="flex-grow">
            <div id="tab-content-list">
                 <div id="dashboard-list" class="space-y-3"></div>
            </div>

            <div id="tab-content-calendar" class="hidden-view">
                <div class="bg-surfaceVariant/30 p-6 rounded-[28px] mb-6 border border-surfaceVariant/20">
                    <div class="grid grid-cols-7 mb-4 text-center text-sm font-medium text-onSurfaceVariant">
                        <div>M</div><div>S</div><div>S</div><div>R</div><div>K</div><div>J</div><div>S</div>
                    </div>
                    <div id="calendar-container" class="calendar-grid"></div>
                </div>
                
                <div class="flex justify-between items-center mb-4 px-2">
                    <h3 class="font-medium text-onSurface text-lg" id="selected-date-label">Kegiatan</h3>
                    <button onclick="app.createForSelectedDate()" id="btn-add-date" class="hidden-view text-sm bg-secondaryContainer text-onSecondaryContainer px-4 py-2 rounded-full font-medium hover:shadow transition">
                        + Tambah
                    </button>
                </div>
                <div id="calendar-day-list" class="space-y-3 pb-4"></div>
            </div>
        </div>

        <template id="template-empty">
            <div class="flex flex-col items-center justify-center py-20 text-center">
                <div class="w-24 h-24 bg-surfaceVariant rounded-[28px] flex items-center justify-center mb-4 text-onSurfaceVariant opacity-50">
                    <i data-lucide="clipboard-list" width="48" height="48"></i>
                </div>
                <h3 class="text-onSurface font-medium text-lg">Tidak ada data</h3>
                <p class="text-onSurfaceVariant text-sm max-w-[200px]">Belum ada jurnal untuk periode ini.</p>
            </div>
        </template>
    </div>

    <!-- VIEW: ADMIN MONITOR -->
    <div id="view-monitor" class="hidden-view pb-28 px-4 max-w-2xl mx-auto min-h-screen flex flex-col bg-surface">
         <div class="pt-4 pb-2 flex justify-center items-center bg-surface sticky top-0 z-30">
            <span class="text-lg font-bold text-onSurface flex items-center gap-2">
                <i data-lucide="shield-check" class="text-primary" width="20" height="20"></i> Monitor KS
            </span>
        </div>
        
        <div class="py-4 space-y-4">
            <div class="relative">
                <label class="text-xs font-bold text-secondary uppercase tracking-wider mb-1 block">Pilih Guru</label>
                <select id="admin-filter-guru" onchange="app.fetchAdminHistory()" class="w-full appearance-none bg-surfaceVariant/50 text-onSurface pl-4 pr-10 py-3 rounded-xl border-none focus:ring-2 focus:ring-primary">
                    <option value="">Semua Guru</option>
                </select>
                <i data-lucide="chevron-down" width="16" height="16" class="absolute right-3 top-9 pointer-events-none text-onSurfaceVariant"></i>
            </div>
            <div class="grid grid-cols-2 gap-3">
                 <div class="relative">
                     <label class="text-xs font-bold text-secondary uppercase tracking-wider mb-1 block">Dari</label>
                     <input type="date" id="admin-filter-start" onchange="app.fetchAdminHistory()" class="w-full px-3 py-2 bg-surfaceVariant/30 border border-outline/30 rounded-lg text-sm text-onSurface">
                 </div>
                 <div class="relative">
                     <label class="text-xs font-bold text-secondary uppercase tracking-wider mb-1 block">Sampai</label>
                     <input type="date" id="admin-filter-end" onchange="app.fetchAdminHistory()" class="w-full px-3 py-2 bg-surfaceVariant/30 border border-outline/30 rounded-lg text-sm text-onSurface">
                 </div>
            </div>
        </div>
        <div id="admin-list-container" class="space-y-3 flex-grow mt-2"></div>
    </div>


    <!-- VIEW: PROFILE -->
    <div id="view-profile" class="hidden-view pb-28 px-4 max-w-2xl mx-auto min-h-screen flex flex-col bg-surface">
         <div class="pt-4 pb-2 flex justify-center items-center bg-surface sticky top-0 z-30">
            <span class="text-lg font-medium text-onSurface">Profil Guru</span>
        </div>

        <div class="flex flex-col items-center py-8">
            <div class="w-24 h-24 rounded-full bg-primaryContainer text-onPrimaryContainer flex items-center justify-center font-bold text-4xl mb-4 shadow-sm border-4 border-surface">
                <span id="profile-initial">G</span>
            </div>
            <h2 class="text-2xl font-normal text-onSurface text-center px-4" id="profile-name">Nama Guru</h2>
            <div class="mt-2 px-3 py-1 bg-surfaceVariant rounded-full text-onSurfaceVariant text-sm font-medium" id="profile-role">Guru</div>
        </div>

        <div class="space-y-4 w-full">
            <div class="bg-surfaceVariant/30 p-5 rounded-[24px] border border-surfaceVariant/50">
                <div class="space-y-3">
                    <div>
                        <label class="text-xs font-bold text-secondary uppercase tracking-wider">NIP</label>
                        <p class="text-lg text-onSurface" id="profile-nip">-</p>
                    </div>
                    <div class="h-px bg-surfaceVariant/50"></div>
                    <div>
                        <label class="text-xs font-bold text-secondary uppercase tracking-wider">Unit Kerja</label>
                        <p class="text-lg text-onSurface" id="profile-school">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-surface p-5 rounded-[24px] border border-outline/30 shadow-sm">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-full bg-secondaryContainer flex items-center justify-center text-onSecondaryContainer">
                        <i data-lucide="printer" width="20" height="20"></i>
                    </div>
                    <div>
                        <h3 class="text-base font-bold text-onSurface">Laporan Kinerja</h3>
                        <p class="text-xs text-onSurfaceVariant">Cetak atau Unduh Data</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="relative">
                        <label class="text-[10px] uppercase font-bold text-secondary mb-1 block">Dari</label>
                        <input type="date" id="report-start" class="w-full px-3 py-2 bg-surfaceVariant/30 border border-outline/30 rounded-lg text-sm text-onSurface focus:border-primary focus:ring-1 focus:ring-primary outline-none transition">
                    </div>
                    <div class="relative">
                        <label class="text-[10px] uppercase font-bold text-secondary mb-1 block">Sampai</label>
                        <input type="date" id="report-end" class="w-full px-3 py-2 bg-surfaceVariant/30 border border-outline/30 rounded-lg text-sm text-onSurface focus:border-primary focus:ring-1 focus:ring-primary outline-none transition">
                    </div>
                </div>

                <div class="flex gap-3">
                     <button onclick="app.printReport()" class="flex-1 py-3 bg-primary text-onPrimary rounded-full font-medium text-sm shadow hover:shadow-lg transition flex items-center justify-center gap-2">
                        <i data-lucide="file-text" width="16" height="16"></i> PDF
                    </button>
                    <button onclick="app.downloadExcel()" class="flex-1 py-3 bg-primaryContainer text-onPrimaryContainer border border-primary/10 rounded-full font-medium text-sm shadow-sm hover:shadow transition flex items-center justify-center gap-2">
                        <i data-lucide="sheet" width="16" height="16"></i> Excel
                    </button>
                </div>
            </div>

            <button onclick="app.logout()" class="w-full py-4 mt-4 text-error font-medium bg-error/5 rounded-full hover:bg-error/10 transition border border-error/10 flex items-center justify-center gap-2">
                <i data-lucide="log-out" width="18" height="18"></i> Keluar Aplikasi
            </button>
            
             <p class="text-center text-xs text-onSurfaceVariant/50 pb-4">Versi 2.0.0 (Fixed)</p>
        </div>
    </div>

    <!-- VIEW: FORM -->
    <div id="view-form" class="hidden-view bg-surface min-h-screen relative z-50">
        <div class="sticky top-0 bg-surface z-20 px-4 py-4 flex items-center gap-4 border-b border-surfaceVariant/50">
            <button onclick="app.navigate('dashboard')" class="w-10 h-10 rounded-full hover:bg-surfaceVariant flex items-center justify-center text-onSurfaceVariant transition">
                <i data-lucide="arrow-left" width="24" height="24"></i>
            </button>
            <h2 class="text-xl font-normal text-onSurface flex-grow" id="form-title">Jurnal Baru</h2>
            <button type="button" id="btn-simpan-header" onclick="document.getElementById('form-jurnal').dispatchEvent(new Event('submit'))" class="text-primary font-medium text-sm px-4 py-2 bg-primaryContainer text-onPrimaryContainer rounded-full hover:shadow transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                Simpan
            </button>
        </div>
        
        <form id="form-jurnal" class="p-4 space-y-6 max-w-lg mx-auto pb-24">
            <input type="hidden" id="inp-id" value="">
            
            <div class="bg-surface p-0">
                <h3 class="text-sm font-bold text-secondary uppercase tracking-wider mb-4">Waktu Pelaksanaan</h3>
                <div class="grid grid-cols-1 gap-4">
                    <div class="relative">
                        <input type="date" id="inp-tanggal" required class="w-full px-4 py-3 bg-transparent border border-outline rounded-lg text-onSurface focus:border-primary focus:ring-1 focus:ring-primary outline-none transition">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="relative">
                            <label class="absolute -top-2 left-3 bg-surface px-1 text-xs text-onSurfaceVariant">Mulai</label>
                            <input type="time" id="inp-mulai" required class="w-full px-4 py-3 bg-transparent border border-outline rounded-lg text-onSurface focus:border-primary focus:ring-1 focus:ring-primary outline-none transition">
                        </div>
                        <div class="relative">
                            <label class="absolute -top-2 left-3 bg-surface px-1 text-xs text-onSurfaceVariant">Selesai</label>
                            <input type="time" id="inp-selesai" required class="w-full px-4 py-3 bg-transparent border border-outline rounded-lg text-onSurface focus:border-primary focus:ring-1 focus:ring-primary outline-none transition">
                        </div>
                    </div>
                </div>
            </div>

            <div class="h-px bg-surfaceVariant"></div>

            <!-- Kegiatan dengan Suggestion -->
            <div class="relative">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-sm font-bold text-secondary uppercase tracking-wider">Uraian Kegiatan</label>
                    <button type="button" onclick="app.toggleVoice('kegiatan')" id="btn-voice-kegiatan" class="w-8 h-8 rounded-full bg-secondaryContainer text-onSecondaryContainer flex items-center justify-center">
                        <i data-lucide="mic" width="16" height="16"></i>
                    </button>
                </div>
                <textarea id="inp-kegiatan" required rows="4" class="w-full p-4 bg-surfaceVariant/30 rounded-2xl border-none focus:ring-2 focus:ring-primary text-onSurface placeholder-onSurfaceVariant/50 resize-none" placeholder="Ceritakan kegiatan hari ini..."></textarea>
                <!-- Suggestion List Container -->
                <div id="suggest-kegiatan" class="suggestion-list hidden-view"></div>
            </div>

            <!-- Hasil dengan Suggestion -->
            <div class="relative">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-sm font-bold text-secondary uppercase tracking-wider">Hasil / Output</label>
                    <button type="button" onclick="app.toggleVoice('hasil')" id="btn-voice-hasil" class="w-8 h-8 rounded-full bg-secondaryContainer text-onSecondaryContainer flex items-center justify-center">
                        <i data-lucide="mic" width="16" height="16"></i>
                    </button>
                </div>
                <textarea id="inp-hasil" required rows="2" class="w-full p-4 bg-surfaceVariant/30 rounded-2xl border-none focus:ring-2 focus:ring-primary text-onSurface placeholder-onSurfaceVariant/50 resize-none" placeholder="Hasil yang dicapai..."></textarea>
                <!-- Suggestion List Container -->
                <div id="suggest-hasil" class="suggestion-list hidden-view"></div>
            </div>

            <!-- Foto -->
            <div>
                <label class="text-sm font-bold text-secondary uppercase tracking-wider block mb-3">Dokumentasi</label>
                <div class="flex flex-col gap-4">
                    <div class="flex gap-3">
                        <!-- IN-APP CAMERA BUTTON -->
                        <div class="flex-1">
                            <button type="button" onclick="app.startCamera()" class="w-full py-3 px-4 rounded-xl border border-outline text-onSurfaceVariant bg-surface hover:bg-surfaceVariant transition flex items-center justify-center gap-2 cursor-pointer">
                                <i data-lucide="camera" width="20" height="20"></i> Kamera
                            </button>
                        </div>
                        
                        <!-- Input Gallery -->
                        <div class="flex-1">
                            <input type="file" id="inp-foto-gallery" accept="image/*" class="hidden">
                             <label for="inp-foto-gallery" class="w-full py-3 px-4 rounded-xl border border-outline text-onSurfaceVariant bg-surface hover:bg-surfaceVariant transition flex items-center justify-center gap-2 cursor-pointer">
                                <i data-lucide="image" width="20" height="20"></i> Galeri
                            </label>
                        </div>
                    </div>

                    <div id="preview-container" class="relative hidden-view">
                        <!-- Used regular IMG tag instead of objectURL to prevent cleanup issues in WebView -->
                        <img id="img-preview" src="" alt="Preview" class="w-full h-48 object-cover rounded-2xl shadow-sm">
                        <button type="button" onclick="app.clearImage()" class="absolute top-2 right-2 w-8 h-8 bg-surface/80 backdrop-blur rounded-full flex items-center justify-center text-error shadow-sm">
                            <i data-lucide="x" width="18" height="18"></i>
                        </button>
                    </div>
                    <!-- Hidden input to store Base64 string for saving -->
                    <input type="hidden" id="final-photo-base64">
                    <input type="hidden" id="existing-photo-url">
                </div>
            </div>
            
            <div class="h-8"></div>
        </form>
    </div>

    <!-- MD3 BOTTOM NAVIGATION BAR -->
    <nav id="bottom-nav" class="hidden-view fixed bottom-0 left-0 right-0 h-[80px] bg-surface border-t border-surfaceVariant/50 flex justify-evenly items-center z-40 max-w-2xl mx-auto">
        <button onclick="app.switchTab('list')" class="nav-item group flex flex-col items-center gap-1 w-20" data-target="dashboard">
            <div class="nav-indicator w-16 h-8 rounded-full flex items-center justify-center transition-colors duration-300">
                <i data-lucide="layout-list" width="24" height="24"></i>
            </div>
            <span class="text-xs font-medium text-onSurfaceVariant group-hover:text-onSurface">Jurnal</span>
        </button>

        <button onclick="app.switchTab('calendar')" class="nav-item group flex flex-col items-center gap-1 w-20" data-target="calendar">
            <div class="nav-indicator w-16 h-8 rounded-full flex items-center justify-center transition-colors duration-300">
                <i data-lucide="calendar-days" width="24" height="24"></i>
            </div>
            <span class="text-xs font-medium text-onSurfaceVariant group-hover:text-onSurface">Kalender</span>
        </button>
        
        <button onclick="app.navigate('monitor')" id="nav-monitor" class="hidden-view nav-item group flex flex-col items-center gap-1 w-20" data-target="monitor">
            <div class="nav-indicator w-16 h-8 rounded-full flex items-center justify-center transition-colors duration-300">
                <i data-lucide="shield-check" width="24" height="24"></i>
            </div>
            <span class="text-xs font-medium text-onSurfaceVariant group-hover:text-onSurface">Monitor</span>
        </button>

        <div class="absolute bottom-[88px] right-4 md:right-auto md:translate-x-[260px]">
            <button onclick="app.createNew()" class="w-14 h-14 bg-primaryContainer text-onPrimaryContainer rounded-[16px] shadow-lg hover:shadow-xl transition-all active:scale-95 flex items-center justify-center">
                <i data-lucide="plus" width="28" height="28"></i>
            </button>
        </div>

        <button onclick="app.navigate('profile')" class="nav-item group flex flex-col items-center gap-1 w-20" data-target="profile">
            <div class="nav-indicator w-16 h-8 rounded-full flex items-center justify-center transition-colors duration-300">
                <i data-lucide="user" width="24" height="24"></i>
            </div>
            <span class="text-xs font-medium text-onSurfaceVariant group-hover:text-onSurface">Profil</span>
        </button>
    </nav>
    
    <!-- PDF Generation Container (Hidden View, displayed when generating PDF) -->
    <div id="report-container" class="hidden-view">
        <div class="text-center mb-6">
            <h2 class="font-bold text-xl uppercase tracking-wide">LAPORAN KINERJA HARIAN GURU</h2>
            <p id="print-school-header" class="text-lg font-bold uppercase"></p>
        </div>

        <div class="mb-6 text-sm grid grid-cols-2 gap-x-8 gap-y-2">
            <div>
                <p><span class="inline-block w-24 font-bold">Nama</span>: <span class="print-name"></span></p>
                <p><span class="inline-block w-24 font-bold">NIP</span>: <span class="print-nip"></span></p>
            </div>
            <div>
                <p><span class="inline-block w-24 font-bold">Unit Kerja</span>: <span class="print-school"></span></p>
                <p><span class="inline-block w-24 font-bold">Periode</span>: <span class="print-period"></span></p>
            </div>
        </div>

        <table class="w-full mb-8 border-collapse border border-black text-xs">
            <thead>
                <tr class="bg-gray-100">
                    <th style="width: 5%; border: 1px solid black; padding: 6px; text-align: center;">No</th>
                    <th style="width: 15%; border: 1px solid black; padding: 6px; text-align: center;">Hari/Tanggal</th>
                    <th style="width: 12%; border: 1px solid black; padding: 6px; text-align: center;">Waktu</th>
                    <th style="width: 38%; border: 1px solid black; padding: 6px; text-align: center;">Uraian Kegiatan</th>
                    <th style="width: 20%; border: 1px solid black; padding: 6px; text-align: center;">Hasil / Output</th>
                    <th style="width: 10%; border: 1px solid black; padding: 6px; text-align: center;">Lampiran</th>
                </tr>
            </thead>
            <tbody id="print-table-body"></tbody>
        </table>

        <div class="flex justify-between px-4 mt-8">
             <div class="text-center w-64">
                <p class="mb-16">Mengetahui,<br/>Kepala Sekolah</p>
                <p class="font-bold underline mb-1" id="print-ks-name">(Nama Kepala Sekolah)</p>
                <p class="text-xs">NIP. <span id="print-ks-nip">...</span></p>
            </div>

            <div class="text-center w-64">
                <p class="mb-1"><span id="print-city">Jakarta</span>, <span id="print-date">...</span></p>
                <p class="mb-16">Guru Yang Bersangkutan</p>
                <p class="font-bold underline print-name mb-1"></p>
                <p class="print-nip-prefix text-xs">NIP. <span class="print-nip"></span></p>
            </div>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxZdbql7FcEdv8808ikm9fpaYRylggG1alsCRZ18uFdJk2iYjCPqbGfuClhBCW7t0RclA/exec";
        
        // City will be updated by fetchRefs
        let APP_CITY = "Jakarta";

        const app = {
            user: null,
            history: [],
            meta: {}, 
            teachers: [],
            refs: { kegiatan: [], hasil: [] }, 
            
            // --- UPDATED STATE VARIABLES FOR ROBUST CAMERA ---
            currentPhotoBase64: "", // Now stores full Base64 string directly
            isListening: null,
            selectedDate: null, 
            currentTab: 'list', 
            isAdmin: false,
            videoStream: null,
            facingMode: 'environment', // Default to back camera for journals

            init: function() {
                this.initFilters('filter-month', 'filter-year');
                this.fetchRefs(); 

                const stored = localStorage.getItem('jg_user');
                if (stored) {
                    this.user = JSON.parse(stored);
                    this.checkAdminStatus();
                    this.navigate('dashboard');
                } else {
                    this.navigate('login');
                }
                
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                document.getElementById('report-start').value = firstDay.toISOString().split('T')[0];
                document.getElementById('report-end').value = today.toISOString().split('T')[0];
                document.getElementById('admin-filter-start').value = firstDay.toISOString().split('T')[0];
                document.getElementById('admin-filter-end').value = today.toISOString().split('T')[0];

                document.getElementById('form-login').addEventListener('submit', (e) => this.handleLogin(e));
                document.getElementById('form-jurnal').addEventListener('submit', (e) => this.handleSave(e));
                document.getElementById('inp-foto-gallery').addEventListener('change', (e) => this.handleImage(e));
                
                // Autocomplete Listeners
                this.setupAutocomplete('inp-kegiatan', 'suggest-kegiatan', 'kegiatan');
                this.setupAutocomplete('inp-hasil', 'suggest-hasil', 'hasil');

                lucide.createIcons();
            },
            
            // --- ROBUST CAMERA LOGIC (Adopted from Presensi Mobile) ---
            startCamera: async function() {
                // Ensure clean start
                if(this.videoStream) {
                    this.videoStream.getTracks().forEach(track => track.stop());
                }
                
                document.getElementById('modal-camera').classList.remove('hidden-view');
                
                try {
                    const constraints = { 
                        video: { 
                            facingMode: this.facingMode,
                            // Adding resolution constraints often fixes "dark" or "green" screens on Android WebViews
                            // by forcing the hardware into a standard video mode.
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    };
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.videoStream = stream;
                    const video = document.getElementById('camera-stream');
                    video.srcObject = stream;
                    
                    // Explicit play is required on some WebViews
                    video.onloadedmetadata = () => {
                        video.play();
                    };
                    
                    // Handle mirroring for front camera
                    if (this.facingMode === 'user') {
                        video.style.transform = "scaleX(-1)";
                    } else {
                        video.style.transform = "scaleX(1)";
                    }
                } catch (err) {
                    alert("Gagal membuka kamera. Pastikan izin kamera diberikan.");
                    console.error(err);
                    this.stopCamera();
                }
            },

            stopCamera: function() {
                if (this.videoStream) {
                    this.videoStream.getTracks().forEach(track => track.stop());
                    this.videoStream = null;
                }
                document.getElementById('modal-camera').classList.add('hidden-view');
            },
            
            switchCamera: function() {
                this.facingMode = (this.facingMode === 'environment') ? 'user' : 'environment';
                this.startCamera(); // Restart with new mode
            },

            takePicture: function() {
                const video = document.getElementById('camera-stream');
                const canvas = document.getElementById('camera-canvas');
                const context = canvas.getContext('2d');
                
                // Match canvas size to video stream size
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Draw current frame
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Convert directly to Base64 (JPEG quality 0.5)
                const dataUrl = canvas.toDataURL('image/jpeg', 0.5);
                
                // Stop camera immediately to save battery/resources
                this.stopCamera();
                
                // Set the result
                this.setPhotoResult(dataUrl);
            },
            
            // --- GALLERY LOGIC (Unified with Camera) ---
            handleImage: function(e) {
                const file = e.target.files[0];
                if (!file) return;

                if (file.size > 5 * 1024 * 1024) {
                    alert("Ukuran foto terlalu besar (Max 5MB).");
                    e.target.value = ""; 
                    return;
                }
                
                // Convert file to Base64 using FileReader
                const reader = new FileReader();
                reader.onload = (event) => {
                    // Create an image object to potentially resize it (optional but good practice)
                    const img = new Image();
                    img.onload = () => {
                         const canvas = document.createElement('canvas');
                         const MAX_WIDTH = 640; // Resize for consistency
                         const scaleSize = MAX_WIDTH / img.width;
                         canvas.width = MAX_WIDTH;
                         canvas.height = img.height * scaleSize;
                         const ctx = canvas.getContext('2d');
                         ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                         const dataUrl = canvas.toDataURL('image/jpeg', 0.5);
                         
                         this.setPhotoResult(dataUrl);
                    }
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            },
            
            // --- UNIFIED PHOTO SETTER ---
            setPhotoResult: function(base64String) {
                this.currentPhotoBase64 = base64String;
                document.getElementById('final-photo-base64').value = base64String;
                
                const imgPreview = document.getElementById('img-preview');
                imgPreview.src = base64String;
                
                document.getElementById('preview-container').classList.remove('hidden-view');
                document.getElementById('existing-photo-url').value = ""; // Clear existing URL if any
            },

            clearImage: function() {
                this.currentPhotoBase64 = "";
                document.getElementById('final-photo-base64').value = "";
                document.getElementById('inp-foto-gallery').value = "";
                document.getElementById('existing-photo-url').value = "";
                document.getElementById('preview-container').classList.add('hidden-view');
                document.getElementById('img-preview').src = "";
            },
            
            // --- REST OF APP LOGIC ---

            fetchRefs: async function() {
                try {
                    const res = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'get_ref' })
                    }).then(r => r.json());
                    if(res.success) {
                        this.refs.kegiatan = res.kegiatan || [];
                        this.refs.hasil = res.hasil || [];
                        if(res.city) APP_CITY = res.city;
                    }
                } catch(e) { console.error("Err fetch ref"); }
            },

            setupAutocomplete: function(inputId, listId, refKey) {
                const input = document.getElementById(inputId);
                const list = document.getElementById(listId);

                input.addEventListener('input', () => {
                    const val = input.value.toLowerCase();
                    if(val.length < 2) {
                        list.innerHTML = '';
                        list.classList.add('hidden-view');
                        return;
                    }
                    
                    const matches = this.refs[refKey].filter(item => item.toLowerCase().includes(val));
                    
                    if(matches.length > 0) {
                        list.innerHTML = '';
                        matches.forEach(match => {
                            const div = document.createElement('div');
                            div.className = 'suggestion-item';
                            div.innerText = match;
                            div.onclick = () => {
                                input.value = match;
                                list.innerHTML = '';
                                list.classList.add('hidden-view');
                            };
                            list.appendChild(div);
                        });
                        list.classList.remove('hidden-view');
                    } else {
                        list.classList.add('hidden-view');
                    }
                });
                
                document.addEventListener('click', (e) => {
                    if(e.target !== input && e.target !== list) {
                        list.classList.add('hidden-view');
                    }
                });
            },
            
            checkAdminStatus: function() {
                if(!this.user) return;
                const role = (this.user.role || "").toLowerCase();
                if(role.includes("kepala") || role === "ks") {
                    this.isAdmin = true;
                    document.getElementById('nav-monitor').classList.remove('hidden-view');
                    this.fetchTeachers();
                } else {
                    this.isAdmin = false;
                    document.getElementById('nav-monitor').classList.add('hidden-view');
                }
            },
            
            fetchTeachers: async function() {
                if(!this.isAdmin) return;
                try {
                    const res = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'get_teachers' })
                    }).then(r => r.json());
                    if(res.success) {
                        this.teachers = res.data;
                        const sel = document.getElementById('admin-filter-guru');
                        sel.innerHTML = '<option value="">Semua Guru</option>';
                        this.teachers.forEach(t => {
                            const opt = document.createElement('option');
                            opt.value = t.nip;
                            opt.text = t.nama;
                            sel.appendChild(opt);
                        });
                    }
                } catch(e) { console.error("Err fetch teachers"); }
            },

            fetchAdminHistory: async function() {
                if(!this.isAdmin) return;
                this.toggleLoading(true);
                const targetNip = document.getElementById('admin-filter-guru').value;
                const startDate = document.getElementById('admin-filter-start').value;
                const endDate = document.getElementById('admin-filter-end').value;
                
                try {
                     const res = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ 
                            action: 'read_history', 
                            nip: this.user.nip, 
                            asAdmin: true,
                            targetNip: targetNip,
                            startDate: startDate,
                            endDate: endDate
                        })
                    }).then(r => r.json());
                    
                    const container = document.getElementById('admin-list-container');
                    container.innerHTML = '';
                    if(res.success) {
                        if(res.data.length === 0) {
                            container.innerHTML = `<div class="text-center py-10 text-onSurfaceVariant">Tidak ada data.</div>`;
                        } else {
                            res.data.forEach(item => {
                                const el = document.createElement('div');
                                el.className = "bg-surface p-4 rounded-xl border border-surfaceVariant shadow-sm";
                                
                                let attachmentHtml = '';
                                if (item.fotoUrl && item.fotoUrl.startsWith('http')) {
                                    attachmentHtml = `<button onclick="app.viewImage('${item.fotoUrl}')" class="text-primary"><i data-lucide="image" width="16" height="16"></i></button>`;
                                }
                                
                                el.innerHTML = `
                                    <div class="flex justify-between items-start mb-1">
                                        <div class="text-xs font-bold text-primary uppercase">${item.nama}</div>
                                        <div class="text-[10px] text-onSurfaceVariant">${item.tanggal}</div>
                                    </div>
                                    <h4 class="text-sm font-medium text-onSurface">${item.kegiatan}</h4>
                                    <p class="text-xs text-onSurfaceVariant mt-1 line-clamp-2">${item.hasil}</p>
                                    <div class="mt-2 flex items-center gap-2 text-xs text-onSurfaceVariant">
                                        <span class="bg-secondaryContainer px-2 py-0.5 rounded text-onSecondaryContainer">${item.jamMulai} - ${item.jamSelesai}</span>
                                        ${attachmentHtml}
                                    </div>
                                `;
                                container.appendChild(el);
                            });
                            lucide.createIcons();
                        }
                    }
                } catch(e) { alert("Gagal memuat data admin"); }
                this.toggleLoading(false);
            },
            
            initFilters: function(monthId, yearId) {
                const selMonth = document.getElementById(monthId);
                const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                selMonth.innerHTML = ''; 
                months.forEach((m, i) => {
                    const opt = document.createElement('option');
                    opt.value = i + 1;
                    opt.text = m;
                    if(i + 1 === new Date().getMonth() + 1) opt.selected = true;
                    selMonth.appendChild(opt);
                });
                selMonth.addEventListener('change', () => this.fetchHistory());

                const selYear = document.getElementById(yearId);
                const currentYear = new Date().getFullYear();
                selYear.innerHTML = '';
                for (let i = currentYear - 1; i <= currentYear + 1; i++) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.text = i;
                    if(i === currentYear) opt.selected = true;
                    selYear.appendChild(opt);
                }
                selYear.addEventListener('change', () => this.fetchHistory());
            },

            toggleLoading: function(show) {
                document.getElementById('loading-overlay').classList.toggle('hidden-view', !show);
            },
            
            createNew: function() {
                this.resetForm();
                this.navigate('form');
            },

            navigate: function(view) {
                const views = ['login', 'dashboard', 'form', 'profile', 'monitor'];
                views.forEach(v => {
                    const el = document.getElementById(`view-${v}`);
                    if(el) el.classList.add('hidden-view');
                });
                
                document.getElementById('bottom-nav').classList.add('hidden-view');

                const targetEl = document.getElementById(`view-${view}`);
                if(targetEl) targetEl.classList.remove('hidden-view');

                if (['dashboard', 'profile', 'monitor'].includes(view)) {
                    document.getElementById('bottom-nav').classList.remove('hidden-view');
                    this.updateNavHighlight(view);
                }

                if (view === 'dashboard') {
                    this.updateUserInfo();
                    this.fetchHistory();
                    this.switchTab(this.currentTab);
                }
                
                if (view === 'monitor') {
                    this.fetchAdminHistory();
                }
                
                if (view === 'profile') {
                    this.updateUserInfo();
                }

                lucide.createIcons();
            },

            updateNavHighlight: function(target) {
                document.querySelectorAll('.nav-indicator').forEach(el => {
                    el.classList.remove('bg-secondaryContainer', 'text-onSecondaryContainer');
                    el.classList.add('text-onSurfaceVariant');
                });
                
                let selector = `[data-target="${target}"]`;
                if (target === 'dashboard') {
                   selector = `[data-target="${this.currentTab === 'list' ? 'dashboard' : 'calendar'}"]`;
                }

                const activeBtn = document.querySelector(`${selector} .nav-indicator`);
                if(activeBtn) {
                    activeBtn.classList.add('bg-secondaryContainer', 'text-onSecondaryContainer');
                    activeBtn.classList.remove('text-onSurfaceVariant');
                }
            },

            updateUserInfo: function() {
                if(!this.user) return;
                const nameParts = this.user.nama.split(' ');
                
                const dashName = document.getElementById('user-name');
                if(dashName) dashName.innerText = nameParts[0];
                const dashInit = document.getElementById('user-initial');
                if(dashInit) dashInit.innerText = nameParts[0].charAt(0);
                const dashSchool = document.getElementById('user-school');
                if(dashSchool) dashSchool.innerText = this.user.sekolah;
                
                document.getElementById('profile-name').innerText = this.user.nama;
                document.getElementById('profile-initial').innerText = nameParts[0].charAt(0);
                document.getElementById('profile-role').innerText = this.user.role || 'Guru';
                document.getElementById('profile-nip').innerText = this.user.nip;
                document.getElementById('profile-school').innerText = this.user.sekolah;
                
                document.querySelectorAll('.print-name').forEach(el => el.innerText = this.user.nama);
                document.querySelectorAll('.print-nip').forEach(el => el.innerText = this.user.nip);
                document.querySelectorAll('.print-school').forEach(el => el.innerText = this.user.sekolah);
                document.getElementById('print-school-header').innerText = this.user.sekolah;
            },

            switchTab: function(tabName) {
                this.currentTab = tabName;
                const contentCal = document.getElementById('tab-content-calendar');
                const contentList = document.getElementById('tab-content-list');
                
                const dashView = document.getElementById('view-dashboard');
                if (dashView.classList.contains('hidden-view')) {
                     this.navigate('dashboard');
                }

                this.updateNavHighlight('dashboard');

                if (tabName === 'calendar') {
                    contentCal.classList.remove('hidden-view');
                    contentList.classList.add('hidden-view');
                    this.renderCalendar();
                } else {
                    contentList.classList.remove('hidden-view');
                    contentCal.classList.add('hidden-view');
                }
            },

            handleLogin: async function(e) {
                e.preventDefault();
                this.toggleLoading(true);
                document.getElementById('login-error').classList.add('hidden-view');
                const pin = document.getElementById('login-pin').value;
                try {
                    const res = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'login', pin })
                    }).then(r => r.json());

                    if (res.success) {
                        this.user = res.user;
                        localStorage.setItem('jg_user', JSON.stringify(this.user));
                        this.checkAdminStatus();
                        this.navigate('dashboard');
                    } else {
                        document.getElementById('login-error-text').innerText = res.message;
                        document.getElementById('login-error').classList.remove('hidden-view');
                    }
                } catch (err) { alert("Koneksi Error. Cek internet Anda."); }
                this.toggleLoading(false);
            },

            logout: function() {
                if(confirm("Apakah Anda yakin ingin keluar?")) {
                    localStorage.removeItem('jg_user');
                    this.user = null;
                    this.isAdmin = false;
                    this.navigate('login');
                }
            },

            fetchHistory: async function() {
                if(!this.user) return;
                this.toggleLoading(true);
                const month = parseInt(document.getElementById('filter-month').value);
                const year = parseInt(document.getElementById('filter-year').value);

                try {
                    const res = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'read_history', nip: this.user.nip, month, year })
                    }).then(r => r.json());

                    if (res.success) {
                        this.history = res.data;
                        this.meta = res.meta || {}; 
                        this.renderList(res.data);
                        if(this.currentTab === 'calendar') this.renderCalendar();
                        if(this.selectedDate) this.renderDayList(this.selectedDate);
                    }
                } catch(e) { console.error(e); }
                this.toggleLoading(false);
            },
            
            // --- UPDATED PRINT & DOWNLOAD FUNCTIONS FOR WEBVIEW ---
            
            printReport: async function() {
                 if(!this.user) return;
                 const startDate = document.getElementById('report-start').value;
                 const endDate = document.getElementById('report-end').value;
                 if(!startDate || !endDate) { alert("Pilih tanggal awal dan akhir."); return; }
                 
                 this.toggleLoading(true);
                 try {
                    const res = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'read_history', nip: this.user.nip, startDate, endDate })
                    }).then(r => r.json());
                    
                    if(res.success && res.data.length > 0) {
                        // Render table
                        this.renderPrintTable(res.data);
                        
                        // Metadata
                        const ksName = res.meta?.ksName || "(Belum ada KS)";
                        const ksNip = res.meta?.ksNip || "-";
                        document.getElementById('print-ks-name').innerText = ksName;
                        document.getElementById('print-ks-nip').innerText = ksNip;
                        document.getElementById('print-city').innerText = APP_CITY;
                        document.getElementById('print-date').innerText = new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});

                        const s = new Date(startDate).toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'});
                        const e = new Date(endDate).toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'});
                        document.querySelector('.print-period').innerText = `${s} s.d. ${e}`;
                        
                        // Use HTML2PDF instead of window.print
                        const element = document.getElementById('report-container');
                        element.classList.remove('hidden-view'); // Make visible for capture
                        
                        const opt = {
                          margin:       0.5,
                          filename:     `Laporan_${this.user.nama}_${startDate}.pdf`,
                          image:        { type: 'jpeg', quality: 0.98 },
                          html2canvas:  { scale: 2 },
                          jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
                        };
                        
                        await html2pdf().set(opt).from(element).save();
                        
                        element.classList.add('hidden-view'); // Hide again
                        
                    } else {
                        alert("Tidak ada data dalam rentang tanggal tersebut.");
                    }
                 } catch(e) {
                     alert("Gagal memuat data laporan: " + e.message);
                 }
                 this.toggleLoading(false);
            },

            downloadExcel: async function() {
                if(!this.user) return;
                const startDate = document.getElementById('report-start').value;
                const endDate = document.getElementById('report-end').value;
                if(!startDate || !endDate) { alert("Pilih tanggal awal dan akhir."); return; }

                this.toggleLoading(true);
                try {
                    const res = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'read_history', nip: this.user.nip, startDate, endDate })
                    }).then(r => r.json());

                    if (res.success && res.data.length > 0) {
                        const items = res.data;
                        const header = ["Tanggal", "Jam Mulai", "Jam Selesai", "Kegiatan", "Hasil", "Lampiran Foto"];
                        let csvContent = header.join(",") + "\n";
                        
                        items.forEach(item => {
                            let row = [
                                `"${item.tanggal}"`,
                                `"${item.jamMulai}"`,
                                `"${item.jamSelesai}"`,
                                `"${item.kegiatan.replace(/"/g, '""')}"`,
                                `"${item.hasil.replace(/"/g, '""')}"`,
                                `"${item.fotoUrl}"`
                            ];
                            csvContent += row.join(",") + "\n";
                        });

                        // Use Data URI approach instead of Blob for WebView compatibility
                        const uri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent);
                        const link = document.createElement("a");
                        link.setAttribute("href", uri);
                        link.setAttribute("download", `Laporan_${this.user.nama}_${startDate}_${endDate}.csv`);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } else {
                        alert("Tidak ada data untuk periode ini.");
                    }
                } catch(e) {
                    alert("Gagal mengunduh laporan.");
                }
                this.toggleLoading(false);
            },
            
            viewImage: function(url) {
                if(!url) return;
                
                let finalUrl = url;
                
                // Try to extract File ID from common Drive URL patterns
                // Pattern 1: id=...
                // Pattern 2: /d/.../
                // Pattern 3: /file/d/...
                let id = null;
                const idRegex = /[-\w]{25,}/;
                const match = url.match(idRegex);
                if (match && (url.includes('drive.google.com') || url.includes('docs.google.com'))) {
                    id = match[0];
                }

                if(id) {
                    // Use lh3.googleusercontent.com for direct robust embedding
                    // =w1000 means max width 1000px
                    finalUrl = `https://lh3.googleusercontent.com/d/${id}=w1000`;
                }

                const imgEl = document.getElementById('modal-img-display');
                
                imgEl.src = ""; 
                imgEl.classList.add('hidden-view'); // Hide until loaded to avoid ugly borders
                
                // Inline SVG Placeholder
                const placeholder = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 24 24' fill='none' stroke='%23ccc' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='3' width='18' height='18' rx='2' ry='2'/%3E%3Ccircle cx='8.5' cy='8.5' r='1.5'/%3E%3Cpolyline points='21 15 16 10 5 21'/%3E%3C/svg%3E";

                imgEl.onload = function() {
                    this.classList.remove('hidden-view');
                }

                imgEl.onerror = function() {
                    this.onerror = null; 
                    this.src = placeholder;
                    this.classList.remove('hidden-view');
                    // Alert suppressed to avoid spamming the user
                };
                
                imgEl.src = finalUrl;
                document.getElementById('modal-image').classList.remove('hidden-view');
            },
            
            closeImage: function() {
                document.getElementById('modal-image').classList.add('hidden-view');
                setTimeout(() => document.getElementById('modal-img-display').src = "", 300);
            },

            renderCalendar: function() {
                const month = parseInt(document.getElementById('filter-month').value) - 1; 
                const year = parseInt(document.getElementById('filter-year').value);
                const firstDay = new Date(year, month, 1).getDay(); 
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const container = document.getElementById('calendar-container');
                container.innerHTML = '';

                for (let i = 0; i < firstDay; i++) {
                    container.appendChild(document.createElement('div'));
                }

                const today = new Date();
                const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;

                for (let i = 1; i <= daysInMonth; i++) {
                    const cell = document.createElement('div');
                    const dateStr = `${year}-${String(month+1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const hasData = this.history.some(h => h.tanggal === dateStr);
                    
                    let classes = "calendar-day hover:bg-surfaceVariant";
                    if (isCurrentMonth && today.getDate() === i) classes += " today";
                    if (hasData) classes += " has-data";
                    if (this.selectedDate === dateStr) classes += " selected";

                    cell.className = classes;
                    cell.innerText = i;
                    cell.onclick = () => this.selectDate(dateStr, cell);
                    container.appendChild(cell);
                }
            },

            selectDate: function(dateStr, cellEl) {
                document.querySelectorAll('.calendar-day').forEach(c => c.classList.remove('selected'));
                if(cellEl) cellEl.classList.add('selected');
                this.selectedDate = dateStr;
                const d = new Date(dateStr);
                document.getElementById('selected-date-label').innerText = d.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' });
                this.renderDayList(dateStr);
            },

            renderDayList: function(dateStr) {
                const dayData = this.history.filter(h => h.tanggal === dateStr);
                const container = document.getElementById('calendar-day-list');
                const btnAdd = document.getElementById('btn-add-date');
                container.innerHTML = '';
                btnAdd.classList.remove('hidden-view');

                if (dayData.length === 0) {
                    container.innerHTML = `<div class="text-xs text-center text-onSurfaceVariant py-4">Tidak ada kegiatan.</div>`;
                } else {
                    dayData.forEach(item => container.appendChild(this.createListItem(item, true)));
                }
                lucide.createIcons();
            },

            createForSelectedDate: function() {
                if(this.selectedDate) {
                    this.resetForm();
                    document.getElementById('inp-tanggal').value = this.selectedDate;
                    this.navigate('form');
                }
            },

            renderList: function(data) {
                const container = document.getElementById('dashboard-list');
                container.innerHTML = '';
                if (data.length === 0) {
                    container.appendChild(document.getElementById('template-empty').content.cloneNode(true));
                } else {
                    data.forEach(item => container.appendChild(this.createListItem(item)));
                }
                lucide.createIcons();
            },

            createListItem: function(item, isCompact = false) {
                const el = document.createElement('div');
                const dateObj = new Date(item.tanggal);
                const dateNum = dateObj.getDate();
                const dayName = dateObj.toLocaleDateString('id-ID', { weekday: 'short' });
                const safeItem = encodeURIComponent(JSON.stringify(item));
                
                let attachmentHtml = '';
                if (item.fotoUrl && item.fotoUrl.startsWith('http')) {
                    attachmentHtml = `<button onclick="app.viewImage('${item.fotoUrl}')" class="text-primary hover:text-primaryContainer bg-surface p-1 rounded-full"><i data-lucide="image" width="16" height="16"></i></button>`;
                }

                if (isCompact) {
                    el.className = "bg-surface p-4 rounded-xl border border-surfaceVariant flex items-center justify-between";
                    el.innerHTML = `
                         <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold bg-secondaryContainer text-onSecondaryContainer px-2 py-0.5 rounded-full">${item.jamMulai}</span>
                                ${attachmentHtml}
                            </div>
                            <h4 class="text-sm font-medium text-onSurface line-clamp-1">${item.kegiatan}</h4>
                         </div>
                         <button onclick="app.editItem('${safeItem}')" class="p-2 text-onSurfaceVariant"><i data-lucide="chevron-right" width="16" height="16"></i></button>
                    `;
                } else {
                    el.className = "bg-surface p-0 rounded-[24px] border border-surfaceVariant/50 overflow-hidden flex flex-col hover:border-primary/50 transition duration-200 shadow-sm";
                    el.innerHTML = `
                        <div class="flex items-stretch">
                            <div class="w-16 bg-surfaceVariant/30 flex flex-col items-center justify-center border-r border-surfaceVariant/50 p-2">
                                <span class="text-[10px] font-bold text-onSurfaceVariant uppercase">${dayName}</span>
                                <span class="text-xl font-medium text-onSurface">${dateNum}</span>
                            </div>
                            <div class="flex-grow p-4 min-w-0">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="text-xs font-medium text-primary bg-primaryContainer/50 px-2 py-0.5 rounded-md">
                                        ${item.jamMulai} - ${item.jamSelesai}
                                    </span>
                                    <div class="flex gap-1 z-10 relative">
                                         ${attachmentHtml}
                                    </div>
                                </div>
                                <h3 class="text-base font-normal text-onSurface leading-tight mb-1 truncate">${item.kegiatan}</h3>
                                <p class="text-sm text-onSurfaceVariant line-clamp-2">${item.hasil}</p>
                            </div>
                        </div>
                        <div class="bg-surfaceVariant/20 px-4 py-2 flex justify-end gap-3 border-t border-surfaceVariant/50">
                            <button onclick="app.editItem('${safeItem}')" class="text-xs font-medium text-primary hover:text-onPrimaryContainer uppercase tracking-wide flex items-center gap-1">
                                <i data-lucide="pencil" width="12" height="12"></i> UBAH
                            </button>
                            <button onclick="app.deleteItem('${item.id}')" class="text-xs font-medium text-error hover:text-red-700 uppercase tracking-wide flex items-center gap-1">
                                <i data-lucide="trash" width="12" height="12"></i> HAPUS
                            </button>
                        </div>
                    `;
                }
                return el;
            },

            renderPrintTable: function(data) {
                const tbody = document.getElementById('print-table-body');
                if(!tbody) return;
                tbody.innerHTML = '';
                data.forEach((item, index) => {
                    let photoLink = "-";
                    if(item.fotoUrl && item.fotoUrl.startsWith("http")) {
                        photoLink = `<a href="${item.fotoUrl}" target="_blank" style="color:blue; text-decoration:underline;">Lihat</a>`;
                    }
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="border:1px solid black; padding:6px; text-align:center;">${index + 1}</td>
                        <td style="border:1px solid black; padding:6px;">${item.tanggal}</td>
                        <td style="border:1px solid black; padding:6px; text-align:center;">${item.jamMulai} - ${item.jamSelesai}</td>
                        <td style="border:1px solid black; padding:6px;">${item.kegiatan}</td>
                        <td style="border:1px solid black; padding:6px;">${item.hasil}</td>
                        <td style="border:1px solid black; padding:6px; text-align:center;">${photoLink}</td>
                    `;
                    tbody.appendChild(tr);
                });
            },

            deleteItem: async function(id) {
                if(!confirm("Yakin ingin menghapus jurnal ini?")) return;
                this.toggleLoading(true);
                try {
                    const res = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'delete', id })
                    }).then(r => r.json());
                    if(res.success) { this.fetchHistory(); } else { alert("Gagal hapus"); }
                } catch(e) { alert("Error"); }
                this.toggleLoading(false);
            },

            editItem: function(encodedItem) {
                const item = JSON.parse(decodeURIComponent(encodedItem));
                this.navigate('form');
                document.getElementById('form-title').innerText = "Edit Jurnal";
                document.getElementById('inp-id').value = item.id;
                document.getElementById('inp-tanggal').value = item.tanggal;
                document.getElementById('inp-mulai').value = item.jamMulai;
                document.getElementById('inp-selesai').value = item.jamSelesai;
                document.getElementById('inp-kegiatan').value = item.kegiatan;
                document.getElementById('inp-hasil').value = item.hasil;
                this.clearImage(); 
                if (item.fotoUrl && item.fotoUrl.startsWith('http')) {
                    document.getElementById('existing-photo-url').value = item.fotoUrl;
                    document.getElementById('img-preview').src = item.fotoUrl;
                    document.getElementById('preview-container').classList.remove('hidden-view');
                }
            },

            resetForm: function() {
                document.getElementById('form-title').innerText = "Jurnal Baru";
                document.getElementById('inp-id').value = "";
                document.getElementById('existing-photo-url').value = "";
                
                const now = new Date();
                const yyyy = now.getFullYear();
                const mm = String(now.getMonth() + 1).padStart(2, '0');
                const dd = String(now.getDate()).padStart(2, '0');
                document.getElementById('inp-tanggal').value = `${yyyy}-${mm}-${dd}`;
                
                document.getElementById('inp-kegiatan').value = '';
                document.getElementById('inp-hasil').value = '';
                this.clearImage();
            },

            handleSave: async function(e) {
                e.preventDefault();
                this.toggleLoading(true);
                
                const btnSimpan = document.getElementById('btn-simpan-header');
                const originalText = btnSimpan.innerHTML;
                btnSimpan.innerHTML = `<i data-lucide="loader-2" class="animate-spin" width="16" height="16"></i> Menyimpan...`;
                btnSimpan.disabled = true;
                lucide.createIcons();

                // USE THE UNIFIED BASE64 VARIABLE
                let photoData = this.currentPhotoBase64 || document.getElementById('existing-photo-url').value;
                const data = {
                    id: document.getElementById('inp-id').value, 
                    nip: this.user.nip,
                    nama: this.user.nama,
                    tanggal: document.getElementById('inp-tanggal').value,
                    jamMulai: document.getElementById('inp-mulai').value,
                    jamSelesai: document.getElementById('inp-selesai').value,
                    kegiatan: document.getElementById('inp-kegiatan').value,
                    hasil: document.getElementById('inp-hasil').value,
                    foto: photoData 
                };

                try {
                    const res = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'save', data })
                    }).then(r => r.json());
                    if(res.success) { this.navigate('dashboard'); } else { alert(res.message); }
                } catch(e) { alert("Error saving"); }
                
                this.toggleLoading(false);
                btnSimpan.innerHTML = originalText;
                btnSimpan.disabled = false;
                lucide.createIcons();
            },

            toggleVoice: function(field) {
                if (!('webkitSpeechRecognition' in window)) { alert("Fitur suara tidak didukung browser ini."); return; }
                if (this.isListening) return; 
                const recognition = new window.webkitSpeechRecognition();
                recognition.lang = 'id-ID';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
                const btn = document.getElementById(`btn-voice-${field}`);
                btn.classList.add('text-error', 'animate-pulse');
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    const input = document.getElementById(`inp-${field}`);
                    input.value = input.value ? input.value + ' ' + transcript : transcript;
                };
                recognition.onend = () => {
                    this.isListening = false;
                    btn.classList.remove('text-error', 'animate-pulse');
                };
                this.isListening = true;
                recognition.start();
            },
        };
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
